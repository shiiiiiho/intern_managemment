<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        background-color: #f4f7f9;
      }
      nav {
        background-color: #fff;
        padding: 10px 20px;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      .nav-tab {
        display: inline-block;
        padding: 10px 15px;
        text-decoration: none;
        color: #007bff;
        font-weight: bold;
        cursor: pointer;
        border-radius: 4px;
      }
      .nav-tab:hover {
        background-color: #f0f0f0;
      }

      .view {
        display: none; /* Changed from display: block; for calendar-view */
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      div {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type='date'],
      input[type='time'],
      textarea,
      select {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      #status-message {
        margin-top: 15px;
        font-weight: bold;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      #daily-reports-table {
        table-layout: fixed;
      }
      #daily-reports-table th:nth-child(5),
      #daily-reports-table td:nth-child(5) {
        width: 20%;
      }
      #daily-reports-table th:nth-child(6),
      #daily-reports-table td:nth-child(6) {
        width: 20%;
      }
      #daily-reports-table th:nth-child(4),
      #daily-reports-table td:nth-child(4) {
        width: 16%;
      }
      .approve-btn {
        background-color: #28a745;
      }
      .reject-btn {
        background-color: #dc3545;
      }
      .approve-btn:hover {
        background-color: #218838;
      }
      .reject-btn:hover {
        background-color: #c82333;
      }
      .permission-denied {
        color: #dc3545;
        font-weight: bold;
      }
      .star-rating {
        display: inline-block;
        font-size: 2em;
        cursor: pointer;
      }
      .star {
        color: #ccc;
      }
      .star.selected {
        color: #ffc107;
      }

      /* Centering for form elements inside the main view */
      #shift-form,
      #work-instruction-form,
      #daily-report-form {
        max-width: 600px;
        margin: 0 auto;
      }

      /* Modal Styles */
      #modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none; /* Initially hidden */
        justify-content: center;
        align-items: center;
      }
      #shift-details-modal {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      #modal-close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        font-weight: bold;
        border: none;
        background: none;
        cursor: pointer;
      }

      /* Calendar Day Colors */
      .fc-day-sun {
        background-color: #fff0f0;
      }
      .fc-day-sat {
        background-color: #f0f8ff;
      }
      .fc-day-holiday {
        background-color: #fff0f0; /* Same as Sunday */
      }
      .fc-day-sun a.fc-daygrid-day-number,
      .fc-day-holiday a.fc-daygrid-day-number {
        color: red;
        font-weight: bold;
      }
      .fc-day-sat a.fc-daygrid-day-number {
        color: blue;
        font-weight: bold;
      }

      /* Custom Event Color for Work Instructions */
      .fc-event-work-instruction {
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        display: inline-block; /* Make it take only necessary width */
        white-space: nowrap; /* Prevent wrapping */
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%; /* Ensure it doesn't overflow its container */
        font-size: 0.85em;
        line-height: 1.2;
      }
      .fc-event-work-instruction .fc-event-title {
        text-align: center;
        width: 100%;
        display: block;
      }
      /* Compact calendar events to prevent overflow in day cells */
      .fc .fc-daygrid-event {
        font-size: 0.85em;
        line-height: 1.2;
        padding: 2px 3px;
        min-height: 22px;
        display: block;
        overflow: hidden;
      }
      /* Shift: 2 lines (name + time), no ellipsis */
      .fc-event-shift {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }
      .fc-event-shift-header {
        display: flex;
        align-items: center;
        gap: 4px;
        min-width: 0;
      }
      .fc-event-shift .fc-event-label {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
      }
      /* Instruction: single line */
      .fc-event-anchor {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .fc-event-anchor .fc-event-label {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .fc-event-cancelled .fc-event-label,
      .fc-event-cancelled .fc-event-time {
        text-decoration: line-through;
        opacity: 0.6;
      }
      .fc-event-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex: 0 0 auto;
      }
      .fc-event-label {
        flex: 1 1 auto;
        min-width: 0;
        font-weight: 500;
      }
      .fc-event-time {
        font-size: 0.8em;
        color: #555;
        opacity: 0.9;
        white-space: nowrap;
        flex: 0 0 auto;
      }
      .fc-event-anchor .fc-event-time {
        color: inherit;
      }

      /* Global Loading Overlay */
      #global-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 2000; /* Highest z-index */
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 16px;
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }
      .roulette {
        display: flex;
        gap: 6px;
        font-weight: 800;
        font-size: 36px;
        letter-spacing: 2px;
        color: #5e99fb;
      }
      .roulette span {
        width: 28px;
        text-align: center;
        display: inline-block;
      }
      .loading-text {
        color: #5e99fb;
        font-weight: 700;
        letter-spacing: 1px;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/japanese-holidays@1.0.10/lib/japanese-holidays.min.js"></script>
  </head>
  <body>
    <div
      id="login-view"
      style="
        max-width: 400px;
        margin: 100px auto;
        padding: 40px;
        background: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        text-align: center;
      "
    >
      <h1 style="margin-bottom: 30px">ãƒ­ã‚°ã‚¤ãƒ³</h1>
      <p>æ°åã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      <select id="user-select" style="width: 100%; padding: 10px; margin-bottom: 20px"></select>
      <button onclick="handleLogin()" style="width: 100%; padding: 10px">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="login-status" style="margin-top: 15px; color: red"></p>
    </div>

    <div id="global-loader" style="display: none">
      <div class="roulette" id="roulette">
        <span>P</span>
        <span>A</span>
        <span>S</span>
        <span>S</span>
        <span>C</span>
      </div>
      <div class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <script>
      // User info will be populated in APP_DATA.userInfo
      const rouletteChars = 'PASSC';
      const charPool = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let rouletteTimer = null;

      function startRoulette() {
        const roulette = document.getElementById('roulette');
        if (!roulette) return;
        const slots = roulette.querySelectorAll('span');
        let tick = 0;
        rouletteTimer = setInterval(() => {
          slots.forEach((slot, index) => {
            const stopAt = 10 + index * 3;
            if (tick >= stopAt) {
              slot.textContent = rouletteChars[index];
            } else {
              const randIndex = Math.floor(Math.random() * charPool.length);
              slot.textContent = charPool[randIndex];
            }
          });
          tick += 1;
        }, 70);
      }

      function stopRoulette() {
        if (rouletteTimer) {
          clearInterval(rouletteTimer);
          rouletteTimer = null;
        }
        const roulette = document.getElementById('roulette');
        if (!roulette) return;
        const slots = roulette.querySelectorAll('span');
        slots.forEach((slot, index) => {
          slot.textContent = rouletteChars[index];
        });
      }

      function setGlobalLoaderText(message) {
        const loader = document.getElementById('global-loader');
        if (!loader) return;
        const text = loader.querySelector('.loading-text');
        if (text) {
          text.textContent = message || 'èª­ã¿è¾¼ã¿ä¸­...';
        }
      }

      function showGlobalLoader(message) {
        setGlobalLoaderText(message);
        const loader = document.getElementById('global-loader');
        if (!loader) return;
        loader.style.display = 'flex';
        startRoulette();
      }

      function hideGlobalLoader() {
        const loader = document.getElementById('global-loader');
        if (!loader) return;
        loader.style.display = 'none';
        stopRoulette();
      }
      const detailCache = { shift: {}, instruction: {} };

      function getCachedShiftDetails(shiftId) {
        return detailCache.shift[shiftId] || null;
      }
      function setCachedShiftDetails(shiftId, details) {
        detailCache.shift[shiftId] = details;
      }
      function getCachedScheduleDetails(workId) {
        return detailCache.instruction[workId] || null;
      }
      function setCachedScheduleDetails(workId, details) {
        detailCache.instruction[workId] = details;
      }

      function buildShiftEventHTML({
        title,
        internColor,
        formattedStartTime,
        formattedEndTime,
        isCancelled,
      }) {
        const timeText =
          formattedStartTime && formattedEndTime ? `${formattedStartTime}~${formattedEndTime}` : '';
        const cancelledClass = isCancelled ? ' fc-event-cancelled' : '';
        return `
          <div class="fc-event-shift${cancelledClass}">
            <div class="fc-event-shift-header">
              <span class="fc-event-dot" style="background-color:${internColor || '#ccc'};"></span>
              <span class="fc-event-label">${title}</span>
            </div>
            ${timeText ? `<span class="fc-event-time">${timeText}</span>` : ''}
          </div>
        `;
      }

      function buildInstructionEventHTML({
        title,
        formattedStartTime,
        formattedEndTime,
        category,
        isCancelled,
      }) {
        const timeText =
          formattedStartTime && formattedEndTime ? `${formattedStartTime}~${formattedEndTime}` : '';
        const colorMap = {
          ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼: '#e54b4b',
          æ¡ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ: '#4a90e2',
          Dooox: '#111',
          ãã®ä»–: '#6c63ff',
        };
        const color = colorMap[category] || '#666';
        const textColor = category === 'Dooox' ? '#fff' : '#000';
        const cancelledClass = isCancelled ? ' fc-event-cancelled' : '';

        return `
          <div class="fc-event-anchor${cancelledClass}" style="color:${textColor}; background-color:${color};">
            <span class="fc-event-label">${title}</span>
            ${timeText ? `<span class="fc-event-time">${timeText}</span>` : ''}
          </div>
        `;
      }
    </script>

    <nav style="display: none">
      <a onclick="showView('calendar-view')" class="nav-tab" id="tab-calendar">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
      <a onclick="showView('form-view')" class="nav-tab" id="tab-apply">ğŸ“ ã‚·ãƒ•ãƒˆç”³è«‹</a>
      <a onclick="showView('admin-view')" class="nav-tab" id="tab-admin">ğŸ‘‘ ã‚·ãƒ•ãƒˆç®¡ç†</a>
      <a onclick="showView('work-instruction-view')" class="nav-tab" id="tab-work-instruction"
        >ğŸ—“ï¸ äºˆå®šä½œæˆ</a
      >
      <a onclick="showView('daily-report-input-view')" class="nav-tab" id="tab-daily-report-input"
        >ğŸ“” æ—¥å ±å…¥åŠ›</a
      >
      <a
        onclick="showView('daily-report-management-view')"
        class="nav-tab"
        id="tab-daily-report-management"
        >ğŸ“Š æ—¥å ±ç®¡ç†</a
      >
    </nav>

    <div id="calendar-view" class="view" style="display: none">
      <h1>ã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
      <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap">
        <p style="margin: 0">ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œç¢ºå®šã€ã®ã‚·ãƒ•ãƒˆã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</p>
        <button type="button" id="calendar-refresh-btn">èª­ã¿è¾¼ã¿</button>
      </div>
      <div id="calendar"></div>
    </div>

    <div id="form-view" class="view" style="display: none">
      <h1>ã‚·ãƒ•ãƒˆå¸Œæœ› ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ </h1>
      <form
        id="shift-form"
        onsubmit="
          event.preventDefault();
          handleFormSubmit(this);
        "
      >
        <div>
          <label for="hope-date-year">å¸Œæœ›æ—¥:</label>
          <div style="display: flex; gap: 10px">
            <select id="hope-date-year" style="width: 35%; padding: 8px"></select>
            <select id="hope-date-month" style="width: 30%; padding: 8px"></select>
            <select id="hope-date-day" style="width: 30%; padding: 8px"></select>
          </div>
        </div>
        <div>
          <label>å¸Œæœ›é–‹å§‹æ™‚åˆ»:</label>
          <div style="display: flex; gap: 10px">
            <select id="start-hour" style="width: 50%"></select>
            <select id="start-minute" style="width: 50%"></select>
          </div>
        </div>
        <div>
          <label>å¸Œæœ›çµ‚äº†æ™‚åˆ»:</label>
          <div style="display: flex; gap: 10px">
            <select id="end-hour" style="width: 50%"></select>
            <select id="end-minute" style="width: 50%"></select>
          </div>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <button type="button" id="add-shift-button">è¿½åŠ </button>
          <button type="submit" id="submit-button">ä¸€æ‹¬ç”³è«‹ã™ã‚‹</button>
        </div>
      </form>
      <div id="status-message"></div>
      <div id="pending-shifts" style="margin-top: 15px">
        <h3>ç”³è«‹äºˆå®šãƒªã‚¹ãƒˆ</h3>
        <table id="pending-shifts-table">
          <thead>
            <tr>
              <th>å¸Œæœ›æ—¥</th>
              <th>å¸Œæœ›æ™‚é–“</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="pending-shifts-tbody"></tbody>
        </table>
      </div>

      <hr style="margin: 30px 0" />

      <h2>ã‚ãªãŸã®ç”³è«‹ä¸€è¦§</h2>
      <p id="my-shifts-status">èª­ã¿è¾¼ã¿ä¸­...</p>
      <div id="my-shift-requests-list"></div>
    </div>

    <div id="admin-view" class="view" style="display: none">
      <div id="admin-content-authorized">
        <h1>ã‚·ãƒ•ãƒˆç®¡ç†</h1>
        <div id="admin-controls">
          <button id="show-create-shift-modal-btn" style="margin-bottom: 15px">
            ï¼‹ æ–°è¦ã‚·ãƒ•ãƒˆä½œæˆ
          </button>
          <button id="admin-refresh-btn" style="margin-left: 10px">èª­ã¿è¾¼ã¿</button>
          <button id="admin-notify-btn" style="margin-left: 10px">é€šçŸ¥</button>
          <label for="admin-month-selector">æœˆã‚’é¸æŠ:</label>
          <select id="admin-month-selector"></select>
          <div id="admin-status-filters" style="margin-top: 10px">
            <button class="filter-btn active" data-status="å¸Œæœ›ä¸­">å¸Œæœ›ä¸­</button>
            <button class="filter-btn" data-status="ç¢ºå®š">ç¢ºå®š</button>
            <button class="filter-btn" data-status="æ£„å´">æ£„å´</button>
            <button class="filter-btn" data-status="all">ã™ã¹ã¦</button>
          </div>
        </div>
        <p id="admin-status"></p>
        <table id="admin-shifts-table">
          <thead>
            <tr>
              <th>åˆ¤å®š</th>
              <th>ç”³è«‹æ—¥</th>
              <th>æ°å</th>
              <th>å¸Œæœ›æ—¥</th>
              <th>å¸Œæœ›æ™‚é–“</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="admin-shifts-tbody"></tbody>
        </table>
      </div>
      <div id="admin-content-denied" style="display: none">
        <h1>æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</h1>
        <p class="permission-denied">ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€æ¡ç”¨æ‹…å½“ãŠã‚ˆã³Doooxã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
      </div>
    </div>

    <div id="work-instruction-view" class="view" style="display: none">
      <h1>äºˆå®šä½œæˆ</h1>
      <div id="hr-work-instruction-form">
        <h2>äºˆå®šã®ç™»éŒ²</h2>
        <form
          id="work-instruction-form"
          onsubmit="
            event.preventDefault();
            handleWorkInstructionSubmit(this);
          "
        >
          <div>
            <label for="wi-target-date-year">å¯¾è±¡æ—¥:</label>
            <div style="display: flex; gap: 10px">
              <select id="wi-target-date-year" style="width: 35%; padding: 8px"></select>
              <select id="wi-target-date-month" style="width: 30%; padding: 8px"></select>
              <select id="wi-target-date-day" style="width: 30%; padding: 8px"></select>
            </div>
          </div>
          <div>
            <label>é–‹å§‹æ™‚åˆ»:</label>
            <div style="display: flex; gap: 10px">
              <select id="wi-start-hour" style="width: 50%"></select>
              <select id="wi-start-minute" style="width: 50%"></select>
            </div>
          </div>
          <div>
            <label>çµ‚äº†æ™‚åˆ»:</label>
            <div style="display: flex; gap: 10px">
              <select id="wi-end-hour" style="width: 50%"></select>
              <select id="wi-end-minute" style="width: 50%"></select>
            </div>
          </div>
          <div>
            <label for="wi-work-category">ã‚«ãƒ†ã‚´ãƒª:</label>
            <select
              id="wi-work-category"
              name="workCategory"
              required
              onchange="toggleOtherDescription(this.value)"
            >
              <option value="ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼">ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼</option>
              <option value="æ¡ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ">æ¡ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ</option>
              <option value="Dooox">Dooox</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
          <div id="wi-other-description-container" style="display: none">
            <label for="wi-other-description">äºˆå®šå†…å®¹ï¼ˆãã®ä»–ï¼‰:</label>
            <textarea id="wi-other-description" name="otherDescription" rows="3"></textarea>
          </div>
          <div>
            <label for="wi-memo">ãƒ¡ãƒ¢:</label>
            <textarea id="wi-memo" name="memo" rows="3"></textarea>
          </div>
          <div><button type="submit" id="wi-submit-button">äºˆå®šã‚’ç™»éŒ²</button></div>
        </form>
        <div id="wi-status-message"></div>
      </div>
      <div id="work-instruction-denied" style="display: none">
        <h1>æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</h1>
        <p class="permission-denied">ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€æ¡ç”¨æ‹…å½“ãŠã‚ˆã³Doooxã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
      </div>
    </div>

    <div id="daily-report-input-view" class="view" style="display: none">
      <h1>æ—¥å ±å…¥åŠ›</h1>
      <div id="daily-report-input-content">
        <h2>æ—¥å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
        <form
          id="daily-report-form"
          onsubmit="
            event.preventDefault();
            handleDailyReportSubmit(this);
          "
        >
          <div>
            <label for="dr-attendance-date-year">å‡ºå‹¤æ—¥:</label>
            <div style="display: flex; gap: 10px">
              <select id="dr-attendance-date-year" style="width: 35%; padding: 8px"></select>
              <select id="dr-attendance-date-month" style="width: 30%; padding: 8px"></select>
              <select id="dr-attendance-date-day" style="width: 30%; padding: 8px"></select>
            </div>
          </div>
          <div>
            <label for="dr-satisfaction">ä»Šæ—¥ã®æº€è¶³åº¦:</label>
            <div id="dr-satisfaction" class="star-rating" data-rating="0">
              <span class="star" data-value="1">&#9733;</span>
              <span class="star" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star" data-value="4">&#9733;</span>
              <span class="star" data-value="5">&#9733;</span>
            </div>
            <input
              type="hidden"
              id="dr-satisfaction-value"
              name="satisfaction"
              value="0"
              required
            />
          </div>
          <div>
            <label for="dr-work-content">æ¥­å‹™å†…å®¹:</label
            ><textarea id="dr-work-content" name="workContent" rows="5" required></textarea>
          </div>
          <div>
            <label for="dr-impression">æ‰€æ„Ÿãƒ»å­¦ã³:</label
            ><textarea id="dr-impression" name="impression" rows="5" required></textarea>
          </div>
          <div><button type="submit" id="dr-submit-button">æå‡ºã™ã‚‹</button></div>
        </form>
        <div id="dr-status-message"></div>
      </div>
      <div id="daily-report-input-denied" style="display: none">
        <h1>æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</h1>
        <p class="permission-denied">
          ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿã€æ¡ç”¨æ‹…å½“ã€Doooxã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
        </p>
      </div>
    </div>

    <div id="daily-report-management-view" class="view" style="display: none">
      <h1>æ—¥å ±ç®¡ç†</h1>
      <div id="daily-report-management-content">
        <div id="dr-controls" style="display: flex; gap: 20px; margin-bottom: 20px">
          <div>
            <label for="dr-month-selector">æœˆã‚’é¸æŠ:</label>
            <select id="dr-month-selector"></select>
          </div>
          <div>
            <label for="dr-intern-selector">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿã‚’é¸æŠ:</label>
            <select id="dr-intern-selector"></select>
          </div>
          <div style="display: flex; align-items: flex-end">
            <button type="button" id="daily-report-refresh-btn">èª­ã¿è¾¼ã¿</button>
          </div>
        </div>
        <p id="daily-report-management-status"></p>
        <table id="daily-reports-table">
          <thead>
            <tr>
              <th>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿ</th>
              <th>å‡ºå‹¤æ—¥</th>
              <th>æº€è¶³åº¦</th>
              <th>æ¥­å‹™å†…å®¹</th>
              <th>æ‰€æ„Ÿãƒ»å­¦ã³</th>
              <th>ç®¡ç†è€…FB</th>
              <th>FBå…¥åŠ›è€…</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="daily-reports-tbody"></tbody>
        </table>
      </div>
      <div id="daily-report-management-denied" style="display: none">
        <h1>æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</h1>
        <p class="permission-denied">ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€æ¡ç”¨æ‹…å½“ãŠã‚ˆã³Doooxã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
      </div>
    </div>

    <!-- Shift Details Modal -->
    <div id="modal-overlay" style="display: none">
      <div id="shift-details-modal">
        <button id="modal-close-btn">&times;</button>

        <div id="modal-schedule-details" style="display: none">
          <h2>äºˆå®šè©³ç´°</h2>

          <!-- View Mode -->
          <div id="modal-schedule-view"></div>

          <!-- Edit Mode -->
          <div id="modal-schedule-edit" style="display: none"></div>

          <div id="modal-schedule-status" style="margin-top: 10px; font-weight: bold"></div>

          <!-- Action Buttons -->
          <div
            id="modal-schedule-actions"
            style="
              margin-top: 20px;
              text-align: right;
              border-top: 1px solid #eee;
              padding-top: 15px;
            "
          >
            <button id="modal-schedule-edit-btn" class="approve-btn" style="display: none">
              ç·¨é›†
            </button>
            <button id="modal-schedule-save-btn" class="approve-btn" style="display: none">
              ä¿å­˜
            </button>
            <button id="modal-schedule-uncancel-btn" class="approve-btn" style="display: none">
              ä¸­æ­¢è§£é™¤
            </button>
            <button id="modal-schedule-delete-btn" class="reject-btn" style="display: none">
              å‰Šé™¤
            </button>
            <button id="modal-schedule-cancel-btn" class="reject-btn" style="margin-left: 8px">
              ä¸­æ­¢
            </button>
            <button type="button" id="modal-schedule-close-btn" style="background-color: #6c757d">
              é–‰ã˜ã‚‹
            </button>
          </div>
        </div>

        <!-- Container for Shift Details -->
        <div id="modal-shift-details" style="display: none">
          <h2>ã‚·ãƒ•ãƒˆè©³ç´°</h2>
          <div id="modal-shift-info"></div>
          <!-- Basic info like intern name, date -->
          <hr />

          <!-- Work Instruction Section -->
          <h4>æ¥­å‹™æŒ‡ç¤º</h4>
          <div id="modal-wi-view" class="modal-section-view"></div>
          <div id="modal-wi-edit" class="modal-section-edit" style="display: none"></div>
          <div id="modal-wi-status" style="font-weight: bold; margin-top: 5px"></div>

          <hr />

          <!-- Daily Report Section -->
          <h4>æ—¥å ±</h4>
          <div id="modal-dr-view" class="modal-section-view"></div>
          <div id="modal-dr-edit" class="modal-section-edit" style="display: none"></div>
          <div id="modal-dr-status" style="font-weight: bold; margin-top: 5px"></div>

          <!-- Action Buttons -->
          <div
            id="modal-shift-actions"
            style="
              margin-top: 20px;
              text-align: right;
              border-top: 1px solid #eee;
              padding-top: 15px;
            "
          >
            <button id="modal-shift-edit-btn" class="approve-btn" style="display: none">
              ç·¨é›†
            </button>
            <button id="modal-shift-save-btn" class="approve-btn" style="display: none">
              ä¿å­˜
            </button>
            <button id="modal-shift-uncancel-btn" class="approve-btn" style="display: none">
              ä¸­æ­¢è§£é™¤
            </button>
            <button id="modal-shift-cancel-btn" class="reject-btn" style="margin-left: 8px">
              ä¸­æ­¢
            </button>
            <button type="button" id="modal-shift-close-btn" style="background-color: #6c757d">
              é–‰ã˜ã‚‹
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Create Shift Modal -->
    <div
      id="admin-create-shift-overlay"
      class="modal-overlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        id="admin-create-shift-modal"
        style="
          background-color: #fff;
          padding: 20px;
          border-radius: 8px;
          width: 90%;
          max-width: 500px;
          position: relative;
        "
      >
        <button
          id="admin-create-shift-modal-close-btn"
          style="
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            border: none;
            background: none;
            cursor: pointer;
          "
        >
          &times;
        </button>
        <h2>æ–°è¦ã‚·ãƒ•ãƒˆä½œæˆ</h2>
        <form
          id="admin-create-shift-form"
          onsubmit="
            event.preventDefault();
            handleAdminCreateShiftSubmit(this);
          "
        >
          <div>
            <label for="admin-create-intern-name">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿ:</label>
            <select id="admin-create-intern-name" name="internName" required></select>
          </div>
          <div>
            <label for="admin-create-hope-date-year">æ—¥ä»˜:</label>
            <div style="display: flex; gap: 10px">
              <select id="admin-create-hope-date-year" style="width: 35%; padding: 8px"></select>
              <select id="admin-create-hope-date-month" style="width: 30%; padding: 8px"></select>
              <select id="admin-create-hope-date-day" style="width: 30%; padding: 8px"></select>
            </div>
          </div>
          <div>
            <label>é–‹å§‹æ™‚åˆ»:</label>
            <div style="display: flex; gap: 10px">
              <select id="admin-create-start-hour" style="width: 50%"></select>
              <select id="admin-create-start-minute" style="width: 50%"></select>
            </div>
          </div>
          <div>
            <label>çµ‚äº†æ™‚åˆ»:</label>
            <div style="display: flex; gap: 10px">
              <select id="admin-create-end-hour" style="width: 50%"></select>
              <select id="admin-create-end-minute" style="width: 50%"></select>
            </div>
          </div>
          <div>
            <label for="admin-create-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
            <select id="admin-create-status" name="status">
              <option value="ç¢ºå®š" selected>ç¢ºå®š</option>
              <option value="å¸Œæœ›ä¸­">å¸Œæœ›ä¸­</option>
            </select>
          </div>
          <div style="margin-top: 20px; display: flex; justify-content: space-between">
            <button type="submit" id="admin-create-shift-submit-btn">ä½œæˆã™ã‚‹</button>
            <button
              type="button"
              id="admin-create-shift-cancel-btn"
              style="background-color: #6c757d"
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        </form>
        <div id="admin-create-shift-status" style="margin-top: 10px; font-weight: bold"></div>
      </div>
    </div>

    <script>
      console.log('Script tag started.');

      // ------------------------------------
      // NEW: æ—¥ä»˜é¸æŠã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      // ------------------------------------
      /**
       * æŒ‡å®šã•ã‚ŒãŸæ¥é ­è¾ã‚’æŒã¤å¹´ãƒ»æœˆãƒ»æ—¥ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆãƒ»è¨­å®šã—ã¾ã™ã€‚
       * @param {string} prefix - IDã®æ¥é ­è¾ (ä¾‹: 'hope-date')
       * @param {Date | string | null} initialDate - åˆæœŸè¨­å®šã™ã‚‹æ—¥ä»˜ (Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€'YYYY/MM/DD' or 'YYYY-MM-DD' å½¢å¼ã®æ–‡å­—åˆ—)
       */
      function populateDateSelectors(prefix, initialDate = null) {
        const yearSelect = document.getElementById(`${prefix}-year`);
        const monthSelect = document.getElementById(`${prefix}-month`);
        const daySelect = document.getElementById(`${prefix}-day`);

        if (!yearSelect || !monthSelect || !daySelect) return;

        let date = new Date(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯JSTã®ç¾åœ¨æ—¥æ™‚
        if (initialDate) {
          if (typeof initialDate === 'string') {
            // æ–‡å­—åˆ—ã®åŒºåˆ‡ã‚Šæ–‡å­—ã‚’'-'ã«çµ±ä¸€ã—ã¦ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
            date = new Date(initialDate.replace(/\//g, '-'));
          } else if (initialDate instanceof Date) {
            date = initialDate;
          }
        }

        const currentYear = date.getFullYear();
        const currentMonth = date.getMonth() + 1;
        const currentDay = date.getDate();

        // å¹´ã‚’ç”Ÿæˆ (ç¾åœ¨ã®å‰å¾Œ2å¹´)
        yearSelect.innerHTML = '';
        for (let y = currentYear - 2; y <= currentYear + 2; y++) {
          const option = document.createElement('option');
          option.value = y;
          option.innerText = `${y}å¹´`;
          if (y === currentYear) option.selected = true;
          yearSelect.appendChild(option);
        }

        // æœˆã‚’ç”Ÿæˆ
        monthSelect.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
          const option = document.createElement('option');
          option.value = m;
          option.innerText = `${m}æœˆ`;
          if (m === currentMonth) option.selected = true;
          monthSelect.appendChild(option);
        }

        // æ—¥ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        const updateDays = () => {
          const selectedYear = parseInt(yearSelect.value);
          const selectedMonth = parseInt(monthSelect.value);
          const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
          const previouslySelectedDay = parseInt(daySelect.value) || currentDay;

          daySelect.innerHTML = '';
          for (let d = 1; d <= daysInMonth; d++) {
            const option = document.createElement('option');
            option.value = d;
            option.innerText = `${d}æ—¥`;
            // ä»¥å‰é¸æŠã•ã‚Œã¦ã„ãŸæ—¥ãŒå­˜åœ¨ã™ã‚Œã°ãã‚Œã‚’ç¶­æŒã—ã€ãªã‘ã‚Œã°ç¯„å›²å†…ã®æœ€å¤§å€¤ã«ä¸¸ã‚ã‚‹
            if (d === (previouslySelectedDay > daysInMonth ? daysInMonth : previouslySelectedDay)) {
              option.selected = true;
            }
            daySelect.appendChild(option);
          }
        };

        // åˆæœŸã®æ—¥ã‚’ç”Ÿæˆ
        updateDays();
        // é¸æŠè‚¢ã®ä¸­ã‹ã‚‰æ­£ã—ã„æ—¥ä»˜ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        daySelect.value = currentDay;

        // å¹´æœˆãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰æ—¥ã®é¸æŠè‚¢ã‚’æ›´æ–°
        yearSelect.onchange = updateDays;
        monthSelect.onchange = updateDays;
      }

      /**
       * æŒ‡å®šã•ã‚ŒãŸæ¥é ­è¾ã‚’æŒã¤æ—¥ä»˜ã‚»ãƒ¬ã‚¯ã‚¿ã‹ã‚‰ 'YYYY-MM-DD' å½¢å¼ã®æ–‡å­—åˆ—ã‚’å–å¾—ã—ã¾ã™ã€‚
       * @param {string} prefix - IDã®æ¥é ­è¾
       * @returns {string} 'YYYY-MM-DD' å½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—
       */
      function getDateFromSelectors(prefix) {
        const year = document.getElementById(`${prefix}-year`).value;
        const month = document.getElementById(`${prefix}-month`).value.padStart(2, '0');
        const day = document.getElementById(`${prefix}-day`).value.padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // ------------------------------------
      // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (æ—¥ä»˜)
      // ------------------------------------
      /**
       * 'YYYY/MM/DD' å½¢å¼ã®æ–‡å­—åˆ—ã‚’ 'YYYYå¹´MMæœˆDDæ—¥' ã«å¤‰æ›ã—ã¾ã™ã€‚
       */
      function formatDateJP(dateString) {
        if (!dateString || !/^\d{4}\/\d{2}\/\d{2}$/.test(dateString)) {
          return dateString; // ä¸æ­£ãªå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
        }
        const parts = dateString.split('/');
        return `${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥`;
      }

      // ------------------------------------
      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ï¼† æ¨©é™ãƒã‚§ãƒƒã‚¯
      // ------------------------------------
      function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => (v.style.display = 'none'));

        const userRole = APP_DATA.userInfo.role;
        const isManager =
          userRole === 'æ¡ç”¨æ‹…å½“' || userRole === 'Dooox' || userRole === 'äººäº‹æ‹…å½“';

        // ----- ãƒ“ãƒ¥ãƒ¼ï¼ˆç”»é¢ï¼‰ã®è¡¨ç¤ºåˆ¶å¾¡ -----
        if (viewId === 'form-view') {
          renderMyShiftRequests(APP_DATA.myShiftRequests);
        } else if (viewId === 'admin-view') {
          // ã‚·ãƒ•ãƒˆç®¡ç†
          if (isManager) {
            document.getElementById('admin-content-authorized').style.display = 'block';
            document.getElementById('admin-content-denied').style.display = 'none';
            if (adminDataLoaded) {
              initializeAdminView();
            } else {
              loadAdminDataAndRender({ showLoader: false, renderView: true, force: true });
            }
          } else {
            document.getElementById('admin-content-authorized').style.display = 'none';
            document.getElementById('admin-content-denied').style.display = 'block';
          }
        } else if (viewId === 'work-instruction-view') {
          // äºˆå®šä½œæˆ
          if (isManager || userRole === 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿ') {
            document.getElementById('hr-work-instruction-form').style.display = 'block';
            document.getElementById('work-instruction-denied').style.display = 'none';
          } else {
            document.getElementById('hr-work-instruction-form').style.display = 'none';
            document.getElementById('work-instruction-denied').style.display = 'block';
          }
        } else if (viewId === 'daily-report-input-view') {
          // æ—¥å ±å…¥åŠ›
          const canAccess = userRole === 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿ' || isManager;
          if (canAccess) {
            document.getElementById('daily-report-input-content').style.display = 'block';
            document.getElementById('daily-report-input-denied').style.display = 'none';
            initializeStarRating('dr-satisfaction', 'dr-satisfaction-value');
          } else {
            document.getElementById('daily-report-input-content').style.display = 'none';
            document.getElementById('daily-report-input-denied').style.display = 'block';
          }
        } else if (viewId === 'daily-report-management-view') {
          // æ—¥å ±ç®¡ç†
          if (isManager || userRole === 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿ') {
            document.getElementById('daily-report-management-content').style.display = 'block';
            document.getElementById('daily-report-management-denied').style.display = 'none';
            if (isManager) {
              if (dailyReportDataLoaded) {
                initializeDailyReportManagementView();
              } else {
                loadDailyReportManagementDataAndRender({
                  showLoader: false,
                  renderView: true,
                  force: true,
                });
              }
            } else {
              initializeDailyReportManagementView();
            }
          } else {
            document.getElementById('daily-report-management-content').style.display = 'none';
            document.getElementById('daily-report-management-denied').style.display = 'block';
          }
        }

        document.getElementById(viewId).style.display = 'block';

        // If the calendar view is being displayed, tell the calendar to redraw itself
        // to fix potential rendering issues from being initialized while hidden.
        if (viewId === 'calendar-view') {
          setTimeout(function () {
            calendar.updateSize();
          }, 0); // A minimal timeout allows the browser to apply the 'display: block' before resizing.
        }
      }

      // ------------------------------------
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» (å¤‰æ›´ãªã—)
      // ------------------------------------
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek',
        },
        locale: 'ja',
        displayEventTime: false,
        events: [],
        eventClick: function (info) {
          activeCalendarEvent = info.event;
          const props = info.event.extendedProps;
          document.getElementById('modal-overlay').style.display = 'flex';
          document.getElementById('modal-schedule-details').style.display = 'none';
          document.getElementById('modal-shift-details').style.display = 'none';

          if (props.type === 'shift') {
            document.getElementById('modal-shift-details').style.display = 'block';

            const cachedShiftDetails = getCachedShiftDetails(props.shiftId);
            if (cachedShiftDetails) {
              onShiftDetailsLoaded(cachedShiftDetails);
              return;
            }

            const shiftInfo = (APP_DATA.allShifts || []).find(s => s.shiftId === props.shiftId);
            if (!shiftInfo) {
              fetchShiftDetails(props.shiftId);
              return;
            }

            // Find related daily report
            const dailyReport = (APP_DATA.allDailyReports || []).find(
              dr =>
                dr.internName === shiftInfo.internName && dr.attendanceDate === shiftInfo.hopeDate
            );

            if (!dailyReport) {
              fetchShiftDetails(props.shiftId);
              return;
            }

            onShiftDetailsLoaded({ shiftInfo, dailyReport });
          } else if (props.type === 'instruction') {
            document.getElementById('modal-schedule-details').style.display = 'block';

            const cachedScheduleDetails = getCachedScheduleDetails(props.workId);
            if (cachedScheduleDetails) {
              onScheduleDetailsLoaded(cachedScheduleDetails);
              return;
            }

            const scheduleDetails = (APP_DATA.allWorkInstructions || []).find(
              wi => wi.workId === props.workId
            );
            if (!scheduleDetails) {
              fetchScheduleDetails(props.workId);
              return;
            }
            onScheduleDetailsLoaded(scheduleDetails);
          } else {
            // Clicks on other event types do nothing, close modal
            closeModal();
            info.jsEvent.preventDefault();
          }
        },
        eventContent: function (arg) {
          const props = arg.event.extendedProps;
          if (props.type === 'instruction') {
            return {
              html: buildInstructionEventHTML({
                title: arg.event.title,
                formattedStartTime: props.formattedStartTime,
                formattedEndTime: props.formattedEndTime,
                category: props.category,
                isCancelled: props.isCancelled,
              }),
            };
          }
          if (props.type === 'shift') {
            return {
              html: buildShiftEventHTML({
                title: arg.event.title,
                internColor: props.internColor,
                formattedStartTime: props.formattedStartTime,
                formattedEndTime: props.formattedEndTime,
                isCancelled: props.isCancelled,
              }),
            };
          }
          return { html: arg.event.title };
        },
        dayCellDidMount: function (arg) {
          const holiday = JapaneseHolidays.isHoliday(arg.date);
          if (holiday) {
            arg.el.classList.add('fc-day-holiday');
          }
        },
      });
      function renderCalendarEvents(events) {
        calendar.removeAllEvents();
        calendar.addEventSource(events);
        setTimeout(prefetchDetailsForVisibleEvents, 0);
      }

      function parseYmdToDate(ymd) {
        if (!ymd) {
          return null;
        }
        const parts = ymd.split('/');
        if (parts.length !== 3) {
          return new Date(ymd);
        }
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const day = parseInt(parts[2], 10);
        return new Date(year, month, day);
      }

      function getInternColorFromCalendar(internName) {
        if (!internName) {
          return '#999';
        }
        const existing = calendar
          .getEvents()
          .find(ev => ev.extendedProps && ev.extendedProps.internName === internName);
        return existing && existing.extendedProps && existing.extendedProps.internColor
          ? existing.extendedProps.internColor
          : '#999';
      }

      function addInstructionEventToCalendar(workInstruction) {
        if (!workInstruction) {
          return;
        }
        const date = parseYmdToDate(workInstruction.date);
        if (!date) {
          return;
        }
        const [startHours, startMinutes] = workInstruction.startTime.split(':');
        const [endHours, endMinutes] = workInstruction.endTime.split(':');
        const startDateTime = new Date(date);
        startDateTime.setHours(startHours, startMinutes, 0, 0);
        const endDateTime = new Date(date);
        endDateTime.setHours(endHours, endMinutes, 0, 0);

        const title =
          workInstruction.category === 'ãã®ä»–' && workInstruction.otherDescription
            ? workInstruction.otherDescription
            : workInstruction.category;

        calendar.addEvent({
          title: title,
          start: startDateTime.toISOString(),
          end: endDateTime.toISOString(),
          extendedProps: {
            workId: workInstruction.workId,
            type: 'instruction',
            category: workInstruction.category,
            formattedStartTime: workInstruction.startTime,
            formattedEndTime: workInstruction.endTime,
          },
        });
      }

      function addShiftEventToCalendar(shift) {
        if (!shift || shift.status !== 'ç¢ºå®š') {
          return;
        }
        const date = parseYmdToDate(shift.hopeDate);
        if (!date) {
          return;
        }
        const [startHours, startMinutes] = shift.startTime.split(':');
        const [endHours, endMinutes] = shift.endTime.split(':');
        const startDateTime = new Date(date);
        startDateTime.setHours(startHours, startMinutes, 0, 0);
        const endDateTime = new Date(date);
        endDateTime.setHours(endHours, endMinutes, 0, 0);

        const internColor = getInternColorFromCalendar(shift.internName);
        const title = `${shift.internName} ${shift.startTime}~${shift.endTime}`;

        calendar.addEvent({
          title: title,
          start: startDateTime.toISOString(),
          end: endDateTime.toISOString(),
          extendedProps: {
            shiftId: shift.shiftId,
            type: 'shift',
            internName: shift.internName,
            internColor: internColor,
            formattedStartTime: shift.startTime,
            formattedEndTime: shift.endTime,
          },
        });
      }

      // ------------------------------------
      // ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
      // ------------------------------------
      function onScheduleDetailsLoaded(details) {
        const userRole = APP_DATA.userInfo.role;
        const isManager =
          userRole === 'æ¡ç”¨æ‹…å½“' || userRole === 'Dooox' || userRole === 'äººäº‹æ‹…å½“';

        // --- Clear states and content ---
        document.getElementById('modal-schedule-view').innerHTML = '';
        document.getElementById('modal-schedule-edit').innerHTML = '';
        document.getElementById('modal-schedule-status').innerText = '';

        // --- Reset button states ---
        document.getElementById('modal-schedule-edit-btn').style.display = 'none';
        document.getElementById('modal-schedule-save-btn').style.display = 'none';
        document.getElementById('modal-schedule-uncancel-btn').style.display = 'none';
        document.getElementById('modal-schedule-delete-btn').style.display = 'none';
        document.getElementById('modal-schedule-view').style.display = 'block';
        document.getElementById('modal-schedule-edit').style.display = 'none';
        document.getElementById('modal-schedule-close-btn').onclick = () => closeModal(); // Add this line

        // --- Populate View Mode ---
        document.getElementById('modal-schedule-view').innerHTML = `
            <p><strong>ä½œæˆè€…:</strong> ${details.creatorName}</p>
            <p><strong>æ—¥æ™‚:</strong> ${formatDateJP(details.date)} ${details.startTime} ~ ${details.endTime}</p>
            <p><strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ${details.category}</p>
            ${details.category === 'ãã®ä»–' ? `<p><strong>äºˆå®šå†…å®¹:</strong> ${details.otherDescription || ''}</p>` : ''}
            <p><strong>ãƒ¡ãƒ¢:</strong></p>
            <p style="white-space: pre-wrap; min-height: 2em;">${details.memo || ''}</p>
        `;
        if (details.isCancelled) {
          document.getElementById('modal-schedule-view').innerHTML +=
            '<p style="color:#c00; font-weight:bold;">â€»ä¸­æ­¢æ¸ˆã¿</p>';
        }
        document.getElementById('modal-schedule-uncancel-btn').dataset.cancelled =
          details.isCancelled ? 'true' : 'false';

        // --- Populate Edit Mode (if manager) ---
        if (isManager) {
          let categoryOptions = '';
          const categories = ['ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼', 'æ¡ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ', 'Dooox', 'ãã®ä»–'];
          categories.forEach(cat => {
            const selected = details.category === cat ? 'selected' : '';
            categoryOptions += `<option value="${cat}" ${selected}>${cat}</option>`;
          });

          document.getElementById('modal-schedule-edit').innerHTML = `
              <input type="hidden" id="modal-schedule-workid" value="${details.workId}">
              <div>
                <label for="modal-schedule-date-year">æ—¥ä»˜:</label>
                <div style="display: flex; gap: 10px;">
                  <select id="modal-schedule-date-year" style="width: 35%; padding: 8px;"></select>
                  <select id="modal-schedule-date-month" style="width: 30%; padding: 8px;"></select>
                  <select id="modal-schedule-date-day" style="width: 30%; padding: 8px;"></select>
                </div>
              </div>

              <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                  <label>é–‹å§‹æ™‚åˆ»:</label>
                  <div style="display: flex; gap: 5px;">
                    <select id="modal-start-hour" style="width: 50%;"></select>
                    <select id="modal-start-minute" style="width: 50%;"></select>
                  </div>
                </div>
                <div style="flex: 1;">
                  <label>çµ‚äº†æ™‚åˆ»:</label>
                  <div style="display: flex; gap: 5px;">
                    <select id="modal-end-hour" style="width: 50%;"></select>
                    <select id="modal-end-minute" style="width: 50%;"></select>
                  </div>
                </div>
              </div>

              <div>
                <label for="modal-schedule-category">ã‚«ãƒ†ã‚´ãƒª:</label>
                <select id="modal-schedule-category">${categoryOptions}</select>
              </div>

              <div id="modal-other-description-container" style="${details.category === 'ãã®ä»–' ? 'display: block;' : 'display: none;'} ">
                <label for="modal-other-description">äºˆå®šå†…å®¹ï¼ˆãã®ä»–ï¼‰:</label>
                <textarea id="modal-other-description" rows="3" style="width: 95%;">${details.otherDescription || ''}</textarea>
              </div>

              <div>
                <label for="modal-schedule-memo">ãƒ¡ãƒ¢:</label>
                <textarea id="modal-schedule-memo" rows="4" style="width: 95%;">${details.memo || ''}</textarea>
              </div>
            `;

          // Populate selectors and add listeners after innerHTML is set
          populateDateSelectors('modal-schedule-date', details.date);
          populateTimePickers('modal-start-hour', 'modal-start-minute', details.startTime);
          populateTimePickers('modal-end-hour', 'modal-end-minute', details.endTime);
          document.getElementById('modal-schedule-category').onchange = function () {
            document.getElementById('modal-other-description-container').style.display =
              this.value === 'ãã®ä»–' ? 'block' : 'none';
          };
        }

        // --- Set up button visibility and event listeners ---
        if (isManager) {
          document.getElementById('modal-schedule-edit-btn').style.display = 'inline-block';
          document.getElementById('modal-schedule-delete-btn').style.display = 'inline-block';
        }
        document.getElementById('modal-schedule-edit-btn').onclick = handleScheduleEdit;
        document.getElementById('modal-schedule-save-btn').onclick = handleScheduleSave;
        document.getElementById('modal-schedule-uncancel-btn').onclick = () =>
          handleScheduleUncancel(details.workId);
        document.getElementById('modal-schedule-delete-btn').onclick = () =>
          handleScheduleDelete(details.workId);
      }

      function handleScheduleEdit() {
        document.getElementById('modal-schedule-view').style.display = 'none';
        document.getElementById('modal-schedule-edit').style.display = 'block';
        document.getElementById('modal-schedule-edit-btn').style.display = 'none';
        document.getElementById('modal-schedule-delete-btn').style.display = 'none';
        if (document.getElementById('modal-schedule-uncancel-btn').dataset.cancelled === 'true') {
          document.getElementById('modal-schedule-uncancel-btn').style.display = 'inline-block';
        }
        document.getElementById('modal-schedule-save-btn').style.display = 'inline-block';
      }

      function handleScheduleSave() {
        const formData = {
          workId: document.getElementById('modal-schedule-workid').value,
          targetDate: getDateFromSelectors('modal-schedule-date'),
          startTime:
            document.getElementById('modal-start-hour').value +
            ':' +
            document.getElementById('modal-start-minute').value,
          endTime:
            document.getElementById('modal-end-hour').value +
            ':' +
            document.getElementById('modal-end-minute').value,
          workCategory: document.getElementById('modal-schedule-category').value,
          otherDescription: document.getElementById('modal-other-description').value,
          memo: document.getElementById('modal-schedule-memo').value,
        };

        if (formData.workCategory === 'ãã®ä»–' && !formData.otherDescription) {
          alert('ã€Œãã®ä»–ã€ã‚’é¸æŠã—ãŸå ´åˆã¯äºˆå®šå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (formData.startTime >= formData.endTime) {
          alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const statusDiv = document.getElementById('modal-schedule-status');
        const saveBtn = document.getElementById('modal-schedule-save-btn');
        statusDiv.innerText = 'ä¿å­˜ä¸­...';
        saveBtn.disabled = true;

        google.script.run
          .withSuccessHandler(function (message) {
            statusDiv.innerText = message;
            setTimeout(() => {
              reloadDataAndSwitchToCalendar();
              closeModal();
            }, 1000);
          })
          .withFailureHandler(function (error) {
            statusDiv.innerText = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
            saveBtn.disabled = false;
          })
          .updateFullSchedule(formData);
      }

      function handleScheduleDelete(workId) {
        if (!confirm('æœ¬å½“ã«ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
          return;
        }
        document.getElementById('modal-schedule-status').innerText = 'å‰Šé™¤ä¸­...';
        google.script.run
          .withSuccessHandler(function (message) {
            reloadDataAndSwitchToCalendar(message);
            closeModal();
          })
          .withFailureHandler(function (error) {
            document.getElementById('modal-schedule-status').innerText = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
          })
          .deleteSchedule(workId);
      }

      function handleShiftUncancel(shiftId) {
        if (!confirm('ä¸­æ­¢ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        showGlobalLoader('ä¸­æ­¢è§£é™¤ä¸­...');
        google.script.run
          .withSuccessHandler(function (message) {
            hideGlobalLoader();
            if (activeCalendarEvent) {
              activeCalendarEvent.setExtendedProp('isCancelled', false);
            }
            const cached = getCachedShiftDetails(shiftId);
            if (cached && cached.shiftInfo) {
              cached.shiftInfo.isCancelled = false;
              setCachedShiftDetails(shiftId, cached);
            }
            closeModal();
            alert(message);
          })
          .withFailureHandler(function (error) {
            hideGlobalLoader();
            alert('ä¸­æ­¢è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .uncancelShift(shiftId, APP_DATA.userInfo.name);
      }

      function handleScheduleUncancel(workId) {
        if (!confirm('ä¸­æ­¢ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        showGlobalLoader('ä¸­æ­¢è§£é™¤ä¸­...');
        google.script.run
          .withSuccessHandler(function (message) {
            hideGlobalLoader();
            if (activeCalendarEvent) {
              activeCalendarEvent.setExtendedProp('isCancelled', false);
            }
            const cached = getCachedScheduleDetails(workId);
            if (cached) {
              cached.isCancelled = false;
              setCachedScheduleDetails(workId, cached);
            }
            closeModal();
            alert(message);
          })
          .withFailureHandler(function (error) {
            hideGlobalLoader();
            alert('ä¸­æ­¢è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .uncancelWorkInstruction(workId, APP_DATA.userInfo.name);
      }

      // Generalize populateTimePickers to set initial values
      function populateTimePickers(hourElementId, minuteElementId, initialTime = '09:00') {
        const hourSelect = document.getElementById(hourElementId);
        const minuteSelect = document.getElementById(minuteElementId);

        if (!hourSelect || !minuteSelect) return; // Exit if elements don't exist

        const [initialHour, initialMinute] = initialTime.split(':');

        // Populate hours
        hourSelect.innerHTML = ''; // Clear previous options
        const hourFragment = document.createDocumentFragment();
        for (let h = 0; h < 24; h++) {
          const hour = String(h).padStart(2, '0');
          const option = document.createElement('option');
          option.value = hour;
          option.innerText = `${hour} æ™‚`;
          if (hour === initialHour) option.selected = true;
          hourFragment.appendChild(option);
        }
        hourSelect.appendChild(hourFragment);

        // Populate minutes
        minuteSelect.innerHTML = ''; // Clear previous options
        const minuteFragment = document.createDocumentFragment();
        for (let m = 0; m < 60; m += 10) {
          const minute = String(m).padStart(2, '0');
          const option = document.createElement('option');
          option.value = minute;
          option.innerText = `${minute} åˆ†`;
          if (minute === initialMinute) option.selected = true;
          minuteFragment.appendChild(option);
        }
        minuteSelect.appendChild(minuteFragment);
      }

      let activeShiftDetails = {}; // Store details of the currently open shift modal

      function handleShiftModalEdit() {
        // Toggle visibility
        document.querySelectorAll('.modal-section-view').forEach(el => (el.style.display = 'none'));
        document
          .querySelectorAll('.modal-section-edit')
          .forEach(el => (el.style.display = 'block'));

        // Toggle buttons
        document.getElementById('modal-shift-edit-btn').style.display = 'none';
        document.getElementById('modal-shift-save-btn').style.display = 'inline-block';
        if (document.getElementById('modal-shift-uncancel-btn').dataset.cancelled === 'true') {
          document.getElementById('modal-shift-uncancel-btn').style.display = 'inline-block';
        }
      }

      function handleShiftModalSave() {
        const statusPromises = [];
        const { shiftInfo, dailyReport } = activeShiftDetails;
        const userRole = APP_DATA.userInfo.role;
        const isManager =
          userRole === 'æ¡ç”¨æ‹…å½“' || userRole === 'Dooox' || userRole === 'äººäº‹æ‹…å½“';
        const isOwnerIntern = APP_DATA.userInfo.name === shiftInfo.internName;

        document.getElementById('modal-shift-save-btn').disabled = true;

        // 1. Save Work Instruction if manager
        if (isManager) {
          const wiText = document.getElementById('modal-wi-edit-textarea').value;
          const wiStatusDiv = document.getElementById('modal-wi-status');
          wiStatusDiv.innerText = 'æ¥­å‹™æŒ‡ç¤ºã‚’ä¿å­˜ä¸­...';

          const wiPromise = new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(message => {
                wiStatusDiv.innerText = message;
                resolve();
              })
              .withFailureHandler(error => {
                wiStatusDiv.innerText = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                reject(error);
              })
              .saveWorkInstructionForShift(shiftInfo.shiftId, wiText, APP_DATA.userInfo.name);
          });
          statusPromises.push(wiPromise);
        }

        // 2. Save Daily Report if it's the owner intern
        if (isOwnerIntern) {
          const drStatusDiv = document.getElementById('modal-dr-status');
          const satisfactionInput = document.getElementById('modal-dr-edit-satisfaction-value');
          // formData for either new submission or update
          const formData = {
            satisfaction: satisfactionInput ? satisfactionInput.value : '0',
            workContent: document.getElementById('modal-dr-edit-workContent').value,
            impression: document.getElementById('modal-dr-edit-impression').value,
          };

          let serverCall;
          if (dailyReport && dailyReport.reportId) {
            // It's an UPDATE
            drStatusDiv.innerText = 'æ—¥å ±ã‚’æ›´æ–°ä¸­...';
            serverCall = google.script.run
              .withSuccessHandler(message => {
                drStatusDiv.innerText = message;
              })
              .withFailureHandler(error => {
                drStatusDiv.innerText = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                throw error; // Propagate error to Promise.all
              })
              .updateDailyReport(dailyReport.reportId, formData, APP_DATA.userInfo.name);
          } else {
            // It's a NEW submission
            drStatusDiv.innerText = 'æ—¥å ±ã‚’æå‡ºä¸­...';
            formData.attendanceDate = shiftInfo.hopeDate; // Add date for new report
            serverCall = google.script.run
              .withSuccessHandler(message => {
                drStatusDiv.innerText = message;
              })
              .withFailureHandler(error => {
                drStatusDiv.innerText = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                throw error; // Propagate error to Promise.all
              })
              .submitReport(formData, APP_DATA.userInfo.name);
          }
          statusPromises.push(serverCall);
        }

        // 3. After all promises complete, reload data
        Promise.all(statusPromises)
          .then(() => {
            // Success
            setTimeout(() => {
              reloadDataAndSwitchToCalendar('æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
              closeModal();
            }, 1500); // Wait a bit to show success message
          })
          .catch(err => {
            // Failure
            console.error('Save failed:', err);
            document.getElementById('modal-shift-save-btn').disabled = false;
          });
      }

      function handleShiftModalClose() {
        closeModal();
      }

      function onShiftDetailsLoaded(details) {
        activeShiftDetails = details; // Store details for the save function
        const { shiftInfo, dailyReport } = details;
        const userRole = APP_DATA.userInfo.role;
        const isManager =
          userRole === 'æ¡ç”¨æ‹…å½“' || userRole === 'Dooox' || userRole === 'äººäº‹æ‹…å½“';
        const isOwnerIntern = APP_DATA.userInfo.name === shiftInfo.internName;

        // --- Clear previous content and statuses ---
        document.getElementById('modal-shift-info').innerHTML = '';
        document.getElementById('modal-wi-view').innerHTML = '';
        document.getElementById('modal-wi-edit').innerHTML = '';
        document.getElementById('modal-dr-view').innerHTML = '';
        document.getElementById('modal-dr-edit').innerHTML = '';
        document.getElementById('modal-wi-status').innerText = '';
        document.getElementById('modal-dr-status').innerText = '';

        // --- Reset button states ---
        document.getElementById('modal-shift-edit-btn').style.display = 'none';
        document.getElementById('modal-shift-save-btn').style.display = 'none';
        document.getElementById('modal-shift-uncancel-btn').style.display = 'none';
        document.getElementById('modal-shift-save-btn').disabled = false;
        document
          .querySelectorAll('.modal-section-view')
          .forEach(el => (el.style.display = 'block'));
        document.querySelectorAll('.modal-section-edit').forEach(el => (el.style.display = 'none'));

        // --- Populate Shift Info ---
        document.getElementById('modal-shift-info').innerHTML = `
          <p><strong>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿ:</strong> 
            <span style="display:inline-block; width:10px; height:10px; border-radius:50%; background-color:${shiftInfo.internColor || '#ccc'}; margin-right:5px;"></span>
            ${shiftInfo.internName}
          </p>
          <p><strong>æ—¥æ™‚:</strong> ${formatDateJP(shiftInfo.hopeDate)} ${shiftInfo.startTime} ~ ${shiftInfo.endTime}</p>
        `;
        if (shiftInfo.isCancelled) {
          document.getElementById('modal-shift-info').innerHTML +=
            '<p style="color:#c00; font-weight:bold;">â€»ä¸­æ­¢æ¸ˆã¿</p>';
        }
        document.getElementById('modal-shift-uncancel-btn').dataset.cancelled =
          shiftInfo.isCancelled ? 'true' : 'false';

        // --- Populate Work Instruction (WI) ---
        // View
        document.getElementById('modal-wi-view').innerHTML =
          `<p style="white-space: pre-wrap; min-height: 50px;">${shiftInfo.workInstructionText || (isManager ? 'æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' : 'æŒ‡ç¤ºã¯ã‚ã‚Šã¾ã›ã‚“')}</p>`;
        // Edit (only for managers)
        if (isManager) {
          document.getElementById('modal-wi-edit').innerHTML =
            `<textarea id="modal-wi-edit-textarea" rows="4" style="width: 95%;">${shiftInfo.workInstructionText || ''}</textarea>`;
        }

        // --- Populate Daily Report (DR) ---
        if (dailyReport) {
          // View
          const starDisplay =
            '&#9733;'.repeat(dailyReport.satisfaction) +
            '&#9734;'.repeat(5 - dailyReport.satisfaction);
          document.getElementById('modal-dr-view').innerHTML = `
            <p><strong>æº€è¶³åº¦:</strong> ${starDisplay}</p>
            <p><strong>æ¥­å‹™å†…å®¹:</strong></p>
            <p style="white-space: pre-wrap;">${dailyReport.workContent}</p>
            <p><strong>æ‰€æ„Ÿãƒ»å­¦ã³:</strong></p>
            <p style="white-space: pre-wrap;">${dailyReport.impression}</p>
            ${dailyReport.managerFeedback ? ` <hr><h4>ç®¡ç†è€…ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4><p style="white-space: pre-wrap;">${dailyReport.managerFeedback}</p>` : ''}
          `;
          // Edit (for owner)
          if (isOwnerIntern) {
            document.getElementById('modal-dr-edit').innerHTML = `
              <div>
                <label>ä»Šæ—¥ã®æº€è¶³åº¦:</label>
                <div id="modal-dr-edit-satisfaction" class="star-rating" data-rating="${dailyReport.satisfaction}">
                  <span class="star" data-value="1">&#9733;</span><span class="star" data-value="2">&#9733;</span><span class="star" data-value="3">&#9733;</span><span class="star" data-value="4">&#9733;</span><span class="star" data-value="5">&#9733;</span>
                </div>
                <input type="hidden" id="modal-dr-edit-satisfaction-value" value="${dailyReport.satisfaction}" required>
              </div>
              <div><label>æ¥­å‹™å†…å®¹:</label><textarea id="modal-dr-edit-workContent" rows="4" style="width: 95%;" required>${dailyReport.workContent}</textarea></div>
              <div><label>æ‰€æ„Ÿãƒ»å­¦ã³:</label><textarea id="modal-dr-edit-impression" rows="4" style="width: 95%;" required>${dailyReport.impression}</textarea></div>
            `;
            initializeStarRating('modal-dr-edit-satisfaction', 'modal-dr-edit-satisfaction-value');
          }
        } else {
          // View
          document.getElementById('modal-dr-view').innerHTML =
            `<p>${isOwnerIntern ? 'æ—¥å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' : 'ã“ã®æ—¥ã®æ—¥å ±ã¯ã¾ã æå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'}</p>`;
          // Edit (for owner to submit new)
          if (isOwnerIntern) {
            document.getElementById('modal-dr-edit').innerHTML = `
              <div>
                <label>ä»Šæ—¥ã®æº€è¶³åº¦:</label>
                <div id="modal-dr-edit-satisfaction" class="star-rating" data-rating="0">
                  <span class="star" data-value="1">&#9733;</span><span class="star" data-value="2">&#9733;</span><span class="star" data-value="3">&#9733;</span><span class="star" data-value="4">&#9733;</span><span class="star" data-value="5">&#9733;</span>
                </div>
                <input type="hidden" id="modal-dr-edit-satisfaction-value" value="0" required>
              </div>
              <div><label>æ¥­å‹™å†…å®¹:</label><textarea id="modal-dr-edit-workContent" rows="4" style="width: 95%;" required></textarea></div>
              <div><label>æ‰€æ„Ÿãƒ»å­¦ã³:</label><textarea id="modal-dr-edit-impression" rows="4" style="width: 95%;" required></textarea></div>
            `;
            initializeStarRating('modal-dr-edit-satisfaction', 'modal-dr-edit-satisfaction-value');
          }
        }

        // --- Set up button visibility and event listeners ---
        if (isManager || isOwnerIntern) {
          document.getElementById('modal-shift-edit-btn').style.display = 'inline-block';
        }

        // Add event listeners
        document.getElementById('modal-shift-edit-btn').onclick = handleShiftModalEdit;
        document.getElementById('modal-shift-save-btn').onclick = handleShiftModalSave;
        document.getElementById('modal-shift-uncancel-btn').onclick = () =>
          handleShiftUncancel(shiftInfo.shiftId);
        document.getElementById('modal-shift-close-btn').onclick = handleShiftModalClose;
      }

      function handleCalendarWorkInstructionSave(shiftId) {
        const newText = document.getElementById('modal-work-instruction-text').value;
        document.getElementById('modal-work-instruction-status').innerText = 'ä¿å­˜ä¸­...';

        google.script.run
          .withSuccessHandler(function (message) {
            reloadDataAndSwitchToCalendar(message);
            closeModal();
          })
          .withFailureHandler(function (error) {
            document.getElementById('modal-work-instruction-status').innerText =
              'ã‚¨ãƒ©ãƒ¼: ' + error.message;
          })
          .saveWorkInstructionForShift(shiftId, newText, APP_DATA.userInfo.name);
      }

      function handleCalendarWorkInstructionDelete(shiftId) {
        if (!confirm('ã“ã®æ¥­å‹™æŒ‡ç¤ºã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        document.getElementById('modal-work-instruction-status').innerText = 'å‰Šé™¤ä¸­...';

        google.script.run
          .withSuccessHandler(function (message) {
            reloadDataAndSwitchToCalendar(message);
            closeModal();
          })
          .withFailureHandler(function (error) {
            document.getElementById('modal-work-instruction-status').innerText =
              'ã‚¨ãƒ©ãƒ¼: ' + error.message;
          })
          .deleteWorkInstructionForShift(shiftId, APP_DATA.userInfo.name);
      }

      function handleModalDailyReportSubmit(formObject, attendanceDate) {
        const formData = {
          attendanceDate: attendanceDate,
          satisfaction: formObject.satisfaction.value,
          workContent: formObject.workContent.value,
          impression: formObject.impression.value,
        };
        document.getElementById('modal-dr-submit-button').disabled = true;
        document.getElementById('modal-dr-status-message').innerText = 'é€ä¿¡ä¸­...';

        google.script.run
          .withSuccessHandler(function (message) {
            alert(message); // Give simple feedback
            closeModal(); // Close modal on success
            google.script.run
              .withSuccessHandler(onInitialDataLoaded)
              .getInitialDataForUser(APP_DATA.userInfo.name); // Re-fetch data
          })
          .withFailureHandler(function (error) {
            onFailure(error, 'modal-dr-status-message', 'modal-dr-submit-button');
          })
          .submitReport(formData, APP_DATA.userInfo.name);
      }

      let activeCalendarEvent = null;

      function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
      }

      function fetchShiftDetails(shiftId) {
        const cached = getCachedShiftDetails(shiftId);
        if (cached) {
          onShiftDetailsLoaded(cached);
          return;
        }
        showGlobalLoader('è©³ç´°ã‚’å–å¾—ä¸­...');
        google.script.run
          .withSuccessHandler(function (details) {
            hideGlobalLoader();
            if (!details || !details.shiftInfo) {
              alert('ã‚·ãƒ•ãƒˆè©³ç´°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
              closeModal();
              return;
            }
            if (
              activeCalendarEvent &&
              details.shiftInfo &&
              !details.shiftInfo.internColor &&
              activeCalendarEvent.extendedProps &&
              activeCalendarEvent.extendedProps.internColor
            ) {
              details.shiftInfo.internColor = activeCalendarEvent.extendedProps.internColor;
            }
            if (
              activeCalendarEvent &&
              details.shiftInfo &&
              !details.shiftInfo.isCancelled &&
              activeCalendarEvent.extendedProps &&
              activeCalendarEvent.extendedProps.isCancelled
            ) {
              details.shiftInfo.isCancelled = true;
            }
            setCachedShiftDetails(shiftId, details);
            onShiftDetailsLoaded(details);
          })
          .withFailureHandler(function (error) {
            hideGlobalLoader();
            alert('è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            closeModal();
          })
          .getShiftDetailsBundle(shiftId);
      }

      function fetchScheduleDetails(workId) {
        const cached = getCachedScheduleDetails(workId);
        if (cached) {
          onScheduleDetailsLoaded(cached);
          return;
        }
        showGlobalLoader('è©³ç´°ã‚’å–å¾—ä¸­...');
        google.script.run
          .withSuccessHandler(function (details) {
            hideGlobalLoader();
            if (!details) {
              alert('äºˆå®šè©³ç´°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
              closeModal();
              return;
            }
            if (
              activeCalendarEvent &&
              details &&
              !details.isCancelled &&
              activeCalendarEvent.extendedProps &&
              activeCalendarEvent.extendedProps.isCancelled
            ) {
              details.isCancelled = true;
            }
            setCachedScheduleDetails(workId, details);
            onScheduleDetailsLoaded(details);
          })
          .withFailureHandler(function (error) {
            hideGlobalLoader();
            alert('è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            closeModal();
          })
          .getWorkInstructionById(workId);
      }

      function prefetchShiftDetails(shiftId, internColor) {
        if (getCachedShiftDetails(shiftId)) {
          return;
        }
        google.script.run
          .withSuccessHandler(function (details) {
            if (!details || !details.shiftInfo) {
              return;
            }
            if (!details.shiftInfo.internColor && internColor) {
              details.shiftInfo.internColor = internColor;
            }
            setCachedShiftDetails(shiftId, details);
          })
          .getShiftDetailsBundle(shiftId);
      }

      function prefetchScheduleDetails(workId) {
        if (getCachedScheduleDetails(workId)) {
          return;
        }
        google.script.run
          .withSuccessHandler(function (details) {
            if (!details) {
              return;
            }
            setCachedScheduleDetails(workId, details);
          })
          .getWorkInstructionById(workId);
      }

      function prefetchDetailsForVisibleEvents() {
        if (!calendar) {
          return;
        }
        const events = calendar.getEvents();
        const viewStart = calendar.view.activeStart;
        const viewEnd = calendar.view.activeEnd;
        let shiftCount = 0;
        let instructionCount = 0;

        events.forEach(event => {
          if (!event.start || event.start < viewStart || event.start >= viewEnd) {
            return;
          }
          const props = event.extendedProps || {};
          if (props.type === 'shift' && props.shiftId && shiftCount < 6) {
            if (!getCachedShiftDetails(props.shiftId)) {
              prefetchShiftDetails(props.shiftId, props.internColor);
              shiftCount += 1;
            }
          }
          if (props.type === 'instruction' && props.workId && instructionCount < 6) {
            if (!getCachedScheduleDetails(props.workId)) {
              prefetchScheduleDetails(props.workId);
              instructionCount += 1;
            }
          }
        });
      }

      document.getElementById('modal-close-btn').addEventListener('click', closeModal);
      document.getElementById('modal-schedule-cancel-btn').addEventListener('click', function () {
        if (activeCalendarEvent) {
          const workId = activeCalendarEvent.extendedProps
            ? activeCalendarEvent.extendedProps.workId
            : null;
          if (!workId) {
            alert('äºˆå®šIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            return;
          }
          showGlobalLoader('ä¸­æ­¢ä¸­...');
          google.script.run
            .withSuccessHandler(function (message) {
              hideGlobalLoader();
              activeCalendarEvent.setExtendedProp('isCancelled', true);
              const cached = getCachedScheduleDetails(workId);
              if (cached) {
                cached.isCancelled = true;
                setCachedScheduleDetails(workId, cached);
              }
              closeModal();
              alert(message);
            })
            .withFailureHandler(function (error) {
              hideGlobalLoader();
              alert('ä¸­æ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            })
            .cancelWorkInstruction(workId, APP_DATA.userInfo.name);
        }
      });
      document.getElementById('modal-shift-cancel-btn').addEventListener('click', function () {
        if (activeCalendarEvent) {
          const shiftId = activeCalendarEvent.extendedProps
            ? activeCalendarEvent.extendedProps.shiftId
            : null;
          if (!shiftId) {
            alert('ã‚·ãƒ•ãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            return;
          }
          showGlobalLoader('ä¸­æ­¢ä¸­...');
          google.script.run
            .withSuccessHandler(function (message) {
              hideGlobalLoader();
              activeCalendarEvent.setExtendedProp('isCancelled', true);
              const cached = getCachedShiftDetails(shiftId);
              if (cached && cached.shiftInfo) {
                cached.shiftInfo.isCancelled = true;
                setCachedShiftDetails(shiftId, cached);
              }
              closeModal();
              alert(message);
            })
            .withFailureHandler(function (error) {
              hideGlobalLoader();
              alert('ä¸­æ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            })
            .cancelShift(shiftId, APP_DATA.userInfo.name);
        }
      });
      document.getElementById('modal-overlay').addEventListener('click', function (event) {
        if (event.target === this) {
          // Only close if overlay itself is clicked
          closeModal();
        }
      });

      // ------------------------------------
      // åˆæœŸèª­ã¿è¾¼ã¿
      // ------------------------------------
      let APP_DATA = {}; // Global variable to store all fetched data

      document.addEventListener('DOMContentLoaded', function () {
        // NEW: Set default date for all custom date forms
        populateDateSelectors('hope-date');
        populateDateSelectors('wi-target-date');
        populateDateSelectors('dr-attendance-date');

        // Populate time selectors for all forms
        populateTimePickers('start-hour', 'start-minute');
        populateTimePickers('end-hour', 'end-minute');
        populateTimePickers('wi-start-hour', 'wi-start-minute');
        populateTimePickers('wi-end-hour', 'wi-end-minute');

        calendar.render(); // Render the calendar frame immediately

        // ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
        showGlobalLoader('ãƒ­ã‚°ã‚¤ãƒ³æº–å‚™ä¸­...');
        google.script.run
          .withSuccessHandler(onUsersLoaded)
          .withFailureHandler(onFailure)
          .getUsers();

        renderPendingShifts();
      });

      function onUsersLoaded(response) {
        const userSelect = document.getElementById('user-select');
        if (!userSelect) {
          hideGlobalLoader();
          return;
        }

        if (response && (response.isError || response.debugInfo)) {
          const message = response.errorMessage || response.debugInfo;
          // This is a debug/error object returned by getUsers
          document.getElementById('login-status').textContent = message;
          userSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯è­¦å‘Š</option>';
          alert(`ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã€‘\n${message}`); // Force alert for debug info
          hideGlobalLoader();
          return;
        }

        // If it's a normal array of users
        const users = response; // assuming response is now the array
        userSelect.innerHTML = '<option value="">æ°åã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        users.forEach(user => {
          if (user.name) {
            const option = document.createElement('option');
            option.value = user.name;
            option.textContent = user.name;
            userSelect.appendChild(option);
          }
        });

        if (users.length === 0 && !(response && (response.isError || response.debugInfo))) {
          document.getElementById('login-status').textContent =
            'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
        }
        hideGlobalLoader();
      }

      function handleLogin() {
        const selectedUser = document.getElementById('user-select').value;
        if (!selectedUser) {
          document.getElementById('login-status').textContent = 'æ°åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
          return;
        }

        document.getElementById('login-view').style.display = 'none';
        showGlobalLoader('ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');

        google.script.run
          .withSuccessHandler(onLoginSuccess)
          .withFailureHandler(onLoginFailure)
          .getInitialDataForUser(selectedUser);
      }

      function onLoginSuccess(data) {
        // Configure UI based on user role from the incoming data
        const userRole = data.userInfo.role;
        const isManager =
          userRole === 'æ¡ç”¨æ‹…å½“' || userRole === 'Dooox' || userRole === 'äººäº‹æ‹…å½“';

        // Show/hide tabs based on role
        // ã‚·ãƒ•ãƒˆç®¡ç†(tab-admin)ã®ã¿ç®¡ç†è€…é™å®š
        document.getElementById('tab-admin').style.display = isManager ? 'inline-block' : 'none';

        // Show main navigation
        document.querySelector('nav').style.display = 'block';

        // Now, call the main data handler function.
        // It will set the global APP_DATA, render the calendar, hide the loader, and show the initial view.
        onInitialDataLoaded(data);
        handleCalendarManualRefresh();

        if (isManager) {
          loadAdminDataAndRender({ showLoader: false, renderView: false, force: true });
          loadDailyReportManagementDataAndRender({
            showLoader: false,
            renderView: false,
            force: true,
          });
          handleDailyReportManualRefresh();
        }
      }

      function onLoginFailure(error) {
        document.getElementById('login-view').style.display = 'block';
        hideGlobalLoader();
        document.getElementById('login-status').textContent =
          'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
      }

      function onInitialDataLoaded(data) {
        APP_DATA = data;
        hideGlobalLoader(); // Hide loader

        // Re-render all key components that depend on the new data
        renderCalendarEvents(APP_DATA.calendarEvents);
        renderMyShiftRequests(APP_DATA.myShiftRequests);

        // If admin view is active, re-render it
        if (document.getElementById('admin-view').style.display === 'block') {
          if (adminDataLoaded) {
            initializeAdminView();
          } else {
            loadAdminDataAndRender({ showLoader: true, renderView: true, force: true });
          }
        }
        // If daily report management view is active, re-render it
        if (document.getElementById('daily-report-management-view').style.display === 'block') {
          const userRole = APP_DATA.userInfo.role;
          const isManager =
            userRole === 'æ¡ç”¨æ‹…å½“' || userRole === 'Dooox' || userRole === 'äººäº‹æ‹…å½“';
          if (isManager) {
            if (dailyReportDataLoaded) {
              initializeDailyReportManagementView();
            } else {
              loadDailyReportManagementDataAndRender({
                showLoader: true,
                renderView: true,
                force: true,
              });
            }
          } else {
            initializeDailyReportManagementView();
          }
        }

        // Set initial view only on the very first load
        if (!document.querySelector('.view[style*="block"]')) {
          showView('calendar-view');
        }
      }

      let adminDataLoaded = false;
      let dailyReportDataLoaded = false;
      let adminDataLoading = false;
      let dailyReportDataLoading = false;
      function handleAdminManualRefresh() {
        loadAdminDataAndRender({ showLoader: true, renderView: true, force: true });
      }

      function loadAdminDataAndRender(options = {}) {
        const showLoader = options.showLoader !== false;
        const renderView = options.renderView !== false;
        const force = options.force === true;
        if (adminDataLoading) {
          return;
        }
        if (adminDataLoaded && !force) {
          if (renderView) initializeAdminView();
          return;
        }
        adminDataLoading = true;
        if (showLoader) {
          showGlobalLoader('ã‚·ãƒ•ãƒˆç®¡ç†ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        }
        google.script.run
          .withSuccessHandler(function (data) {
            if (showLoader) {
              hideGlobalLoader();
            }
            APP_DATA.allShifts = data.allShifts || [];
            APP_DATA.allInternNames = data.allInternNames || [];
            adminDataLoaded = true;
            adminDataLoading = false;
            if (renderView) {
              initializeAdminView();
            }
          })
          .withFailureHandler(function (error) {
            if (showLoader) {
              hideGlobalLoader();
            }
            adminDataLoading = false;
            alert('ã‚·ãƒ•ãƒˆç®¡ç†ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .getAdminShiftData(APP_DATA.userInfo.name);
      }

      function loadDailyReportManagementDataAndRender(options = {}) {
        const showLoader = options.showLoader !== false;
        const renderView = options.renderView !== false;
        const force = options.force === true;
        if (dailyReportDataLoading) {
          return;
        }
        if (dailyReportDataLoaded && !force) {
          if (renderView) initializeDailyReportManagementView();
          return;
        }
        dailyReportDataLoading = true;
        if (showLoader) {
          showGlobalLoader('æ—¥å ±ç®¡ç†ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        }
        google.script.run
          .withSuccessHandler(function (data) {
            if (showLoader) {
              hideGlobalLoader();
            }
            APP_DATA.dailyReportsForManager = data.dailyReportsForManager || [];
            APP_DATA.allInternNames = data.allInternNames || [];
            dailyReportDataLoaded = true;
            dailyReportDataLoading = false;
            if (renderView) {
              initializeDailyReportManagementView();
            }
          })
          .withFailureHandler(function (error) {
            if (showLoader) {
              hideGlobalLoader();
            }
            dailyReportDataLoading = false;
            alert('æ—¥å ±ç®¡ç†ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .getDailyReportManagementData(APP_DATA.userInfo.name);
      }

      // ------------------------------------
      // ã‚·ãƒ•ãƒˆç®¡ç†ï¼ˆäººäº‹ãƒ»æ¡ç”¨ç”¨ï¼‰- NEW
      // ------------------------------------
      let adminSelectedMonth = '';
      let adminSelectedStatus = 'å¸Œæœ›ä¸­'; // Default filter

      function initializeAdminView() {
        const allShifts = APP_DATA.allShifts || [];
        const allInterns = APP_DATA.allInternNames || [];
        const monthSelector = document.getElementById('admin-month-selector');
        const refreshBtn = document.getElementById('admin-refresh-btn');

        // Get unique months from all shifts
        const uniqueMonths = [...new Set(allShifts.map(s => s.hopeDate.substring(0, 7)))]
          .sort()
          .reverse();

        monthSelector.innerHTML = '';
        uniqueMonths.forEach(month => {
          const option = document.createElement('option');
          option.value = month;
          option.innerText = month.replace('/', 'å¹´') + 'æœˆ';
          monthSelector.appendChild(option);
        });

        if (uniqueMonths.length > 0) {
          adminSelectedMonth = uniqueMonths[0]; // Default to the latest month
          monthSelector.value = adminSelectedMonth;
        }

        // --- NEW LOGIC FOR CREATE SHIFT MODAL ---

        // 1. Populate intern dropdown in the modal
        const internSelector = document.getElementById('admin-create-intern-name');
        internSelector.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'; // Add a placeholder
        allInterns.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.innerText = name;
          internSelector.appendChild(option);
        });

        // 2. Add event listeners for the modal
        // Use a helper function for consistent modal closing
        function closeAdminCreateShiftModal() {
          document.getElementById('admin-create-shift-overlay').style.display = 'none';
          document.getElementById('admin-create-shift-form').reset();
          document.getElementById('admin-create-shift-status').innerText = ''; // Clear status message
          document.getElementById('admin-create-shift-submit-btn').disabled = false; // Re-enable submit button
        }

        document.getElementById('show-create-shift-modal-btn').addEventListener('click', () => {
          document.getElementById('admin-create-shift-overlay').style.display = 'flex';
          // NEW: Set default date for the modal's date input
          populateDateSelectors('admin-create-hope-date');
          populateTimePickers('admin-create-start-hour', 'admin-create-start-minute');
          populateTimePickers('admin-create-end-hour', 'admin-create-end-minute');
        });

        // Use the helper function for the existing 'x' close button
        document
          .getElementById('admin-create-shift-modal-close-btn')
          .addEventListener('click', closeAdminCreateShiftModal);

        // Add listener for the new 'é–‰ã˜ã‚‹' button
        document
          .getElementById('admin-create-shift-cancel-btn')
          .addEventListener('click', closeAdminCreateShiftModal);

        // --- END NEW LOGIC ---

        if (refreshBtn) {
          refreshBtn.onclick = handleAdminManualRefresh;
        }

        // Add event listeners for filters
        monthSelector.addEventListener('change', function () {
          adminSelectedMonth = this.value;
          renderAdminShifts();
        });

        document.querySelectorAll('#admin-status-filters .filter-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            adminSelectedStatus = this.dataset.status;
            // Active class styling
            document
              .querySelectorAll('#admin-status-filters .filter-btn')
              .forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            renderAdminShifts();
          });
        });

        renderAdminShifts(); // Initial render
      }

      document.getElementById('calendar-refresh-btn').addEventListener('click', () => {
        handleCalendarManualRefresh();
      });

      document.getElementById('daily-report-refresh-btn').addEventListener('click', () => {
        handleDailyReportManualRefresh();
      });

      document.getElementById('add-shift-button').addEventListener('click', () => {
        handleAddShift();
      });

      document.getElementById('admin-notify-btn').addEventListener('click', () => {
        handleBulkNotify();
      });

      function handleAdminCreateShiftSubmit(formObject) {
        const formData = {
          internName: formObject.internName.value,
          hopeDate: getDateFromSelectors('admin-create-hope-date'), // MODIFIED
          startTime:
            document.getElementById('admin-create-start-hour').value +
            ':' +
            document.getElementById('admin-create-start-minute').value,
          endTime:
            document.getElementById('admin-create-end-hour').value +
            ':' +
            document.getElementById('admin-create-end-minute').value,
          status: formObject.status.value,
        };

        if (!formData.internName) {
          alert('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (formData.startTime >= formData.endTime) {
          alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const submitBtn = document.getElementById('admin-create-shift-submit-btn');
        const statusDiv = document.getElementById('admin-create-shift-status');
        submitBtn.disabled = true;
        statusDiv.innerText = 'ä½œæˆä¸­...';

        google.script.run
          .withSuccessHandler(function (response) {
            document.getElementById('admin-create-shift-overlay').style.display = 'none';
            formObject.reset();
            submitBtn.disabled = false;
            statusDiv.innerText = '';
            const message = response && response.message ? response.message : response;
            if (response && response.shift) {
              APP_DATA.allShifts = APP_DATA.allShifts || [];
              APP_DATA.allShifts.push(response.shift);
              renderAdminShifts();
              if (response.shift.status === 'ç¢ºå®š') {
                addShiftEventToCalendar(response.shift);
              }
            }
            alert(message);
          })
          .withFailureHandler(function (error) {
            statusDiv.innerText = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
            submitBtn.disabled = false;
          })
          .adminCreateShift(formData, APP_DATA.userInfo.name);
      }

      function renderAdminShifts() {
        const allShifts = APP_DATA.allShifts || [];
        const tbody = document.getElementById('admin-shifts-tbody');
        tbody.innerHTML = '';

        const filteredShifts = allShifts.filter(shift => {
          const shiftMonth = shift.hopeDate.substring(0, 7);
          const monthMatch = shiftMonth === adminSelectedMonth;
          const statusMatch = adminSelectedStatus === 'all' || shift.status === adminSelectedStatus;
          return monthMatch && statusMatch;
        });

        document.getElementById('admin-status').innerText =
          `${adminSelectedMonth} / ${adminSelectedStatus}: ${filteredShifts.length}ä»¶`;

        if (filteredShifts.length === 0) {
          return;
        }

        filteredShifts.forEach(shift => {
          const tr = document.createElement('tr');
          let decisionCell = '';
          if (shift.status === 'å¸Œæœ›ä¸­') {
            decisionCell = `
              <label><input type="radio" name="decision-${shift.shiftId}" class="bulk-decision" data-row="${shift.rowNumber}" data-id="${shift.shiftId}" value="approve"> æ‰¿èª</label>
              <label style="margin-left: 8px"><input type="radio" name="decision-${shift.shiftId}" class="bulk-decision" data-row="${shift.rowNumber}" data-id="${shift.shiftId}" value="reject"> æ£„å´</label>
            `;
          }

          tr.innerHTML = `
            <td>${decisionCell}</td>
            <td>${formatDateJP(shift.applyDate)}</td>
            <td>${shift.internName}</td>
            <td>${formatDateJP(shift.hopeDate)}</td>
            <td>${shift.startTime} ~ ${shift.endTime}</td>
            <td>${shift.status}</td>
            <td></td>
          `;
          tbody.appendChild(tr);
        });
      }

      function handleBulkNotify() {
        const decisions = document.querySelectorAll('.bulk-decision:checked');
        if (decisions.length === 0) {
          alert('æ‰¿èªã¾ãŸã¯æ£„å´ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        if (!confirm(`${decisions.length}ä»¶ã®é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
          return;
        }
        const items = Array.from(decisions).map(cb => ({
          rowNumber: Number(cb.dataset.row),
          shiftId: cb.dataset.id,
          decision: cb.value,
        }));
        showGlobalLoader('é€šçŸ¥ä¸­...');
        google.script.run
          .withSuccessHandler(function (response) {
            hideGlobalLoader();
            alert(response.message || 'é€šçŸ¥ã—ã¾ã—ãŸã€‚');
            const updated = response.updatedShifts || [];
            updated.forEach(shift => {
              const target = (APP_DATA.allShifts || []).find(s => s.shiftId === shift.shiftId);
              if (target) {
                target.status = shift.status;
              }
              if (shift.status === 'ç¢ºå®š') {
                addShiftEventToCalendar(shift);
              }
            });
            renderAdminShifts();
          })
          .withFailureHandler(function (error) {
            hideGlobalLoader();
            alert('é€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .updateShiftsBatch(items, APP_DATA.userInfo.name);
      }

      function handleApprove(rowNumber, shiftId) {
        if (!confirm('ã“ã®ã‚·ãƒ•ãƒˆã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        google.script.run
          .withSuccessHandler(function (response) {
            const message = response && response.message ? response.message : response;
            alert(message);
            const allShifts = APP_DATA.allShifts || [];
            const target = allShifts.find(shift => shift.shiftId === shiftId);
            if (target) {
              target.status = 'ç¢ºå®š';
              renderAdminShifts();
              addShiftEventToCalendar(target);
            } else {
              reloadDataAndSwitchToCalendar();
            }
          })
          .withFailureHandler(onFailure)
          .approveShift(rowNumber, shiftId, APP_DATA.userInfo.name);
      }

      function handleReject(rowNumber, shiftId) {
        if (!confirm('ã“ã®ã‚·ãƒ•ãƒˆã‚’æ£„å´ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        google.script.run
          .withSuccessHandler(function (response) {
            const message = response && response.message ? response.message : response;
            alert(message);
            const allShifts = APP_DATA.allShifts || [];
            const target = allShifts.find(shift => shift.shiftId === shiftId);
            if (target) {
              target.status = 'æ£„å´';
              renderAdminShifts();
            } else {
              reloadDataAndSwitchToCalendar();
            }
          })
          .withFailureHandler(onFailure)
          .rejectShift(rowNumber, shiftId, APP_DATA.userInfo.name);
      }

      // ------------------------------------
      // ã‚·ãƒ•ãƒˆç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ 
      // ------------------------------------
      let pendingShiftRequests = [];

      function renderPendingShifts() {
        const tbody = document.getElementById('pending-shifts-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (pendingShiftRequests.length === 0) {
          return;
        }
        pendingShiftRequests.forEach((item, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${formatDateJP(item.hopeDate.replace(/-/g, '/'))}</td>
            <td>${item.startTime} ~ ${item.endTime}</td>
            <td><button type="button" onclick="removePendingShift(${index})">å‰Šé™¤</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      function removePendingShift(index) {
        pendingShiftRequests.splice(index, 1);
        renderPendingShifts();
      }

      function handleAddShift() {
        const startHour = document.getElementById('start-hour').value;
        const startMinute = document.getElementById('start-minute').value;
        const endHour = document.getElementById('end-hour').value;
        const endMinute = document.getElementById('end-minute').value;
        const formData = {
          hopeDate: getDateFromSelectors('hope-date'),
          startTime: `${startHour}:${startMinute}`,
          endTime: `${endHour}:${endMinute}`,
        };
        if (formData.startTime >= formData.endTime) {
          alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        const shiftIdInput = document.getElementById('modify-shift-id');
        if (shiftIdInput) {
          shiftIdInput.remove();
          document.getElementById('submit-button').innerText = 'ä¸€æ‹¬ç”³è«‹ã™ã‚‹';
        }
        pendingShiftRequests.push(formData);
        renderPendingShifts();
      }

      function handleFormSubmit(formObject) {
        try {
          const startHour = document.getElementById('start-hour').value;
          const startMinute = document.getElementById('start-minute').value;
          const endHour = document.getElementById('end-hour').value;
          const endMinute = document.getElementById('end-minute').value;

          const shiftIdInput = document.getElementById('modify-shift-id');
          const isModification = shiftIdInput && shiftIdInput.value;
          const hasBatchItems = pendingShiftRequests.length > 0;

          const formData = {
            hopeDate: getDateFromSelectors('hope-date'),
            startTime: `${startHour}:${startMinute}`,
            endTime: `${endHour}:${endMinute}`,
          };

          if (isModification) {
            formData.shiftId = shiftIdInput.value;
          }

          if (formData.startTime >= formData.endTime) {
            alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
            return;
          }

          if (!isModification || hasBatchItems) {
            if (pendingShiftRequests.length === 0) {
              alert('ç”³è«‹äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè¿½åŠ ã€ã§ãƒªã‚¹ãƒˆã«å…¥ã‚Œã¦ãã ã•ã„ã€‚');
              return;
            }
          }

          document.getElementById('submit-button').disabled = true;
          document.getElementById('status-message').innerText = 'é€ä¿¡ä¸­...';

          console.log('batch size:', pendingShiftRequests.length);
          if (!google || !google.script || !google.script.run) {
            throw new Error('google.script.run ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }

          let timeoutId = null;
          const clearTimeoutIfAny = () => {
            if (timeoutId) {
              clearTimeout(timeoutId);
              timeoutId = null;
            }
          };

          const onSubmissionSuccess = response => {
            clearTimeoutIfAny();
            const message = response && response.message ? response.message : response;
            document.getElementById('status-message').innerText = message;
            document.getElementById('submit-button').disabled = false;
            document.getElementById('shift-form').reset();

            populateDateSelectors('hope-date');

            if (isModification && shiftIdInput) {
              shiftIdInput.value = '';
              document.getElementById('submit-button').innerText = 'ä¸€æ‹¬ç”³è«‹ã™ã‚‹';
            }

            const shifts =
              response && response.shifts
                ? response.shifts
                : response && response.shift
                  ? [response.shift]
                  : [];
            if (shifts.length > 0) {
              APP_DATA.myShiftRequests = APP_DATA.myShiftRequests || [];
              shifts.forEach(shift => {
                const index = APP_DATA.myShiftRequests.findIndex(
                  req => req.shiftId === shift.shiftId
                );
                if (index >= 0) {
                  APP_DATA.myShiftRequests[index] = {
                    ...APP_DATA.myShiftRequests[index],
                    ...shift,
                  };
                } else {
                  APP_DATA.myShiftRequests.push(shift);
                }
                if (APP_DATA.allShifts) {
                  const adminIndex = APP_DATA.allShifts.findIndex(s => s.shiftId === shift.shiftId);
                  if (adminIndex >= 0) {
                    APP_DATA.allShifts[adminIndex] = {
                      ...APP_DATA.allShifts[adminIndex],
                      ...shift,
                    };
                  } else {
                    APP_DATA.allShifts.push(shift);
                  }
                }
              });
              renderMyShiftRequests(APP_DATA.myShiftRequests);
              if (APP_DATA.allShifts) renderAdminShifts();
            }
            pendingShiftRequests = [];
            renderPendingShifts();
          };

          const runner = google.script.run
            .withSuccessHandler(onSubmissionSuccess)
            .withFailureHandler(function (error) {
              clearTimeoutIfAny();
              document.getElementById('status-message').innerText =
                'ã‚¨ãƒ©ãƒ¼: ' + (error && error.message ? error.message : 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
              document.getElementById('submit-button').disabled = false;
              console.error(error);
            });

          timeoutId = setTimeout(() => {
            document.getElementById('status-message').innerText =
              'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            document.getElementById('submit-button').disabled = false;
          }, 15000);

          if (!Array.isArray(pendingShiftRequests) || pendingShiftRequests.length === 0) {
            clearTimeoutIfAny();
            document.getElementById('status-message').innerText =
              'ç”³è«‹äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè¿½åŠ ã€ã§ãƒªã‚¹ãƒˆã«å…¥ã‚Œã¦ãã ã•ã„ã€‚';
            document.getElementById('submit-button').disabled = false;
            return;
          }

          if (pendingShiftRequests.length > 0) {
            if (typeof runner.submitShiftRequestsBatch === 'function') {
              runner.submitShiftRequestsBatch(pendingShiftRequests, APP_DATA.userInfo.name);
            } else if (typeof google.script.run.submitShiftRequestsBatch === 'function') {
              google.script.run
                .withSuccessHandler(onSubmissionSuccess)
                .withFailureHandler(function (error) {
                  clearTimeoutIfAny();
                  document.getElementById('status-message').innerText =
                    'ã‚¨ãƒ©ãƒ¼: ' + (error && error.message ? error.message : 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                  document.getElementById('submit-button').disabled = false;
                  console.error(error);
                })
                .submitShiftRequestsBatch(pendingShiftRequests, APP_DATA.userInfo.name);
            } else {
              clearTimeoutIfAny();
              document.getElementById('status-message').innerText =
                'ã‚¨ãƒ©ãƒ¼: ãƒãƒƒãƒç”³è«‹é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚';
              document.getElementById('submit-button').disabled = false;
            }
          } else {
            runner.submitShiftRequest(formData, APP_DATA.userInfo.name);
          }
        } catch (error) {
          document.getElementById('status-message').innerText =
            'ã‚¨ãƒ©ãƒ¼: ' + (error && error.message ? error.message : 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          document.getElementById('submit-button').disabled = false;
          console.error(error);
        }
      }

      // ------------------------------------
      // è‡ªåˆ†ã®ç”³è«‹ä¸€è¦§
      // ------------------------------------
      function renderMyShiftRequests(requests) {
        const listDiv = document.getElementById('my-shift-requests-list');
        const statusP = document.getElementById('my-shifts-status');
        listDiv.innerHTML = '';

        if (requests.length === 0) {
          statusP.innerText = 'ã¾ã ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
          return;
        }

        statusP.innerText = ''; // Clear status message

        // Group by month
        const groupedByMonth = requests.reduce((acc, req) => {
          const month = req.hopeDate.substring(0, 7); // YYYY/MM
          if (!acc[month]) {
            acc[month] = [];
          }
          acc[month].push(req);
          return acc;
        }, {});

        // Render tables for each month
        for (const month in groupedByMonth) {
          let tableHtml = `
            <h3>${month.replace('/', 'å¹´')}æœˆ</h3>
            <table>
              <thead>
                <tr>
                  <th>å¸Œæœ›æ—¥</th>
                  <th>å¸Œæœ›æ™‚é–“</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
          `;
          groupedByMonth[month].forEach(req => {
            const isPending = req.status === 'å¸Œæœ›ä¸­';
            const actionButtons = isPending
              ? `
              <button onclick="handleCancelShift('${req.shiftId}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button onclick="handleModifyShift('${req.shiftId}')">å¤‰æ›´</button>
            `
              : '';

            tableHtml += `
              <tr>
                <td>${formatDateJP(req.hopeDate)}</td>
                <td>${req.startTime} - ${req.endTime}</td>
                <td>${req.status}</td>
                <td>${actionButtons}</td>
              </tr>
            `;
          });
          tableHtml += '</tbody></table>';
          listDiv.innerHTML += tableHtml;
        }
      }

      function handleCancelShift(shiftId) {
        if (!confirm('ã“ã®ã‚·ãƒ•ãƒˆç”³è«‹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        google.script.run
          .withSuccessHandler(function (message) {
            alert(message);
            google.script.run
              .withSuccessHandler(onInitialDataLoaded)
              .getInitialDataForUser(APP_DATA.userInfo.name); // Re-fetch data
          })
          .withFailureHandler(onFailure)
          .cancelShiftRequest(shiftId, APP_DATA.userInfo.name);
      }

      function handleModifyShift(shiftId) {
        const shiftToModify = APP_DATA.myShiftRequests.find(req => req.shiftId === shiftId);
        if (!shiftToModify) {
          alert('å¤‰æ›´ã™ã‚‹ã‚·ãƒ•ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
          return;
        }

        // Pre-fill the form
        populateDateSelectors('hope-date', shiftToModify.hopeDate);
        populateTimePickers('start-hour', 'start-minute', shiftToModify.startTime);
        populateTimePickers('end-hour', 'end-minute', shiftToModify.endTime);

        // Add a hidden input for shiftId to indicate modification
        let shiftIdInput = document.getElementById('modify-shift-id');
        if (!shiftIdInput) {
          shiftIdInput = document.createElement('input');
          shiftIdInput.type = 'hidden';
          shiftIdInput.id = 'modify-shift-id';
          shiftIdInput.name = 'shiftId';
          document.getElementById('shift-form').appendChild(shiftIdInput);
        }
        shiftIdInput.value = shiftId;

        // Change button text
        document.getElementById('submit-button').innerText = 'å¤‰æ›´ã‚’ç”³è«‹ã™ã‚‹';
        alert('ã‚·ãƒ•ãƒˆç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã«å†…å®¹ãŒå…¥åŠ›ã•ã‚Œã¾ã—ãŸã€‚å¤‰æ›´ã—ã¦å†åº¦ç”³è«‹ã—ã¦ãã ã•ã„ã€‚');
      }

      // ------------------------------------
      // äºˆå®šä½œæˆ (äººäº‹ãƒ»æ¡ç”¨ç”¨)
      // ------------------------------------
      function toggleOtherDescription(selectedValue) {
        const otherContainer = document.getElementById('wi-other-description-container');
        otherContainer.style.display = selectedValue === 'ãã®ä»–' ? 'block' : 'none';
      }

      function handleWorkInstructionSubmit(formObject) {
        const startHour = document.getElementById('wi-start-hour').value;
        const startMinute = document.getElementById('wi-start-minute').value;
        const endHour = document.getElementById('wi-end-hour').value;
        const endMinute = document.getElementById('wi-end-minute').value;

        const formData = {
          targetDate: getDateFromSelectors('wi-target-date'), // MODIFIED
          startTime: `${startHour}:${startMinute}`,
          endTime: `${endHour}:${endMinute}`,
          workCategory: formObject.workCategory.value,
          otherDescription: formObject.otherDescription.value,
          memo: formObject.memo.value, // Add memo
        };

        if (formData.workCategory === 'ãã®ä»–' && !formData.otherDescription) {
          alert('ã€Œãã®ä»–ã€ã‚’é¸æŠã—ãŸå ´åˆã¯äºˆå®šå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (formData.startTime >= formData.endTime) {
          alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        document.getElementById('wi-submit-button').disabled = true;
        document.getElementById('wi-status-message').innerText = 'é€ä¿¡ä¸­...';

        google.script.run
          .withSuccessHandler(function (response) {
            const message = response && response.message ? response.message : response;
            // Briefly show success on the form page, then switch.
            document.getElementById('wi-status-message').innerText = message;
            document.getElementById('work-instruction-form').reset();
            populateDateSelectors('wi-target-date'); // Reset date selectors
            document.getElementById('wi-submit-button').disabled = false;

            setTimeout(() => {
              document.getElementById('wi-status-message').innerText = '';
              showView('calendar-view');
              if (response && response.workInstruction) {
                addInstructionEventToCalendar(response.workInstruction);
                setCachedScheduleDetails(response.workInstruction.workId, response.workInstruction);
              } else {
                reloadDataAndSwitchToCalendar(); // fallback
              }
            }, 1000); // 1 second delay to see the message
          })
          .withFailureHandler(function (error) {
            onFailure(error, 'wi-status-message', 'wi-submit-button');
          })
          .submitWorkInstruction(formData, APP_DATA.userInfo.name);
      }

      // ------------------------------------
      // æ—¥å ±å…¥åŠ› (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç”Ÿç”¨)
      // ------------------------------------
      function initializeStarRating(containerId, hiddenInputId) {
        const container = document.getElementById(containerId);
        const hiddenInput = document.getElementById(hiddenInputId);
        const stars = container.querySelectorAll('.star');

        stars.forEach(star => {
          star.addEventListener('click', function () {
            const value = parseInt(this.dataset.value);
            hiddenInput.value = value;
            updateStarRating(container, value);
          });
          star.addEventListener('mouseover', function () {
            const value = parseInt(this.dataset.value);
            updateStarRating(container, value);
          });
          star.addEventListener('mouseout', function () {
            const currentValue = parseInt(hiddenInput.value);
            updateStarRating(container, currentValue);
          });
        });
        updateStarRating(container, parseInt(hiddenInput.value)); // Initial update
      }

      function updateStarRating(container, value) {
        const stars = container.querySelectorAll('.star');
        stars.forEach(star => {
          if (parseInt(star.dataset.value) <= value) {
            star.classList.add('selected');
          } else {
            star.classList.remove('selected');
          }
        });
      }

      function handleDailyReportSubmit(formObject) {
        const formData = {
          attendanceDate: getDateFromSelectors('dr-attendance-date'), // MODIFIED
          satisfaction: formObject.satisfaction.value,
          workContent: formObject.workContent.value,
          impression: formObject.impression.value,
        };
        document.getElementById('dr-submit-button').disabled = true;
        document.getElementById('dr-status-message').innerText = 'é€ä¿¡ä¸­...';

        google.script.run
          .withSuccessHandler(function (message) {
            onSuccess(message, 'dr-status-message', 'dr-submit-button', 'daily-report-form');
          })
          .withFailureHandler(function (error) {
            onFailure(error, 'dr-status-message', 'dr-submit-button');
          })
          .submitReport(formData, APP_DATA.userInfo.name);
      }

      // ------------------------------------
      // æ—¥å ±ç®¡ç† (äººäº‹ãƒ»æ¡ç”¨ç”¨) - NEW
      // ------------------------------------
      let drSelectedMonth = '';
      let drSelectedIntern = 'all';

      function initializeDailyReportManagementView() {
        const allReports = APP_DATA.dailyReportsForManager || [];
        const allInterns = APP_DATA.allInternNames || [];

        const monthSelector = document.getElementById('dr-month-selector');
        const internSelector = document.getElementById('dr-intern-selector');

        // Populate month selector
        const uniqueMonths = [...new Set(allReports.map(r => r.attendanceDate.substring(0, 7)))]
          .sort()
          .reverse();
        monthSelector.innerHTML = '';
        uniqueMonths.forEach(month => {
          const option = document.createElement('option');
          option.value = month;
          option.innerText = month.replace('/', 'å¹´') + 'æœˆ';
          monthSelector.appendChild(option);
        });
        if (uniqueMonths.length > 0) {
          drSelectedMonth = uniqueMonths[0];
          monthSelector.value = drSelectedMonth;
        }

        // Populate intern selector
        internSelector.innerHTML = '<option value="all">å…¨å“¡</option>';
        allInterns.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.innerText = name;
          internSelector.appendChild(option);
        });
        drSelectedIntern = 'all';
        internSelector.value = drSelectedIntern;

        // Add event listeners
        monthSelector.addEventListener('change', function () {
          drSelectedMonth = this.value;
          renderDailyReportsForManager();
        });
        internSelector.addEventListener('change', function () {
          drSelectedIntern = this.value;
          renderDailyReportsForManager();
        });

        renderDailyReportsForManager(); // Initial render
      }

      function renderDailyReportsForManager() {
        const allReports = APP_DATA.dailyReportsForManager || [];
        const tbody = document.getElementById('daily-reports-tbody');
        tbody.innerHTML = '';

        const filteredReports = allReports.filter(report => {
          const monthMatch =
            !drSelectedMonth || report.attendanceDate.substring(0, 7) === drSelectedMonth;
          const internMatch = drSelectedIntern === 'all' || report.internName === drSelectedIntern;
          return monthMatch && internMatch;
        });

        document.getElementById('admin-status').innerText =
          `${drSelectedMonth} / ${drSelectedIntern}: ${filteredReports.length}ä»¶`;

        if (filteredReports.length === 0) {
          return;
        }

        filteredReports.forEach(report => {
          const tr = document.createElement('tr');
          const starDisplay =
            '&#9733;'.repeat(report.satisfaction) + '&#9734;'.repeat(5 - report.satisfaction);
          tr.innerHTML = `
            <td>${report.internName}</td>
            <td>${formatDateJP(report.attendanceDate)}</td>
            <td>${starDisplay}</td>
            <td>${report.workContent}</td>
            <td>${report.impression}</td>
            <td><textarea id="feedback-${report.reportId}" rows="3" style="width: 95%;">${report.managerFeedback || ''}</textarea></td>
            <td>${report.feedbackGiverName || ''}</td>
            <td>
              <button onclick="handleFeedbackSubmit(${report.rowNumber}, '${report.reportId}', document.getElementById('feedback-${report.reportId}').value)">ä¿å­˜</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function handleFeedbackSubmit(rowNumber, reportId, feedbackContent) {
        if (!confirm('ã“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        // No specific status message for individual feedback save, rely on alert
        google.script.run
          .withSuccessHandler(function (message) {
            alert(message);
            google.script.run
              .withSuccessHandler(onInitialDataLoaded)
              .getInitialDataForUser(APP_DATA.userInfo.name); // Re-fetch data
          })
          .withFailureHandler(onFailure)
          .submitFeedback(rowNumber, reportId, feedbackContent, APP_DATA.userInfo.name);
      }

      // Helper function to reload all data and switch to the calendar view
      function reloadDataAndSwitchToCalendar(successMessage) {
        if (successMessage) {
          alert(successMessage);
        }
        showView('calendar-view');
        showGlobalLoader('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ä¸­...');
        google.script.run
          .withSuccessHandler(function (events) {
            APP_DATA.calendarEvents = events || [];
            renderCalendarEvents(APP_DATA.calendarEvents);
            hideGlobalLoader();
          })
          .withFailureHandler(onFailure)
          .getCalendarEventsOnly();
      }

      function handleCalendarManualRefresh() {
        showView('calendar-view');
        showGlobalLoader('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ä¸­...');
        google.script.run
          .withSuccessHandler(function (events) {
            APP_DATA.calendarEvents = events || [];
            renderCalendarEvents(APP_DATA.calendarEvents);
            hideGlobalLoader();
          })
          .withFailureHandler(onFailure)
          .getCalendarEventsOnly();
      }

      function handleDailyReportManualRefresh() {
        loadDailyReportManagementDataAndRender({
          showLoader: true,
          renderView:
            document.getElementById('daily-report-management-view').style.display === 'block',
          force: true,
        });
      }

      // æ±ç”¨æˆåŠŸãƒãƒ³ãƒ‰ãƒ©
      function onSuccess(
        message,
        statusElementId = 'status-message',
        submitButtonId = 'submit-button',
        formId = null
      ) {
        const statusEl = document.getElementById(statusElementId);
        if (statusEl) {
          statusEl.innerText = message;
        }
        const submitBtn = document.getElementById(submitButtonId);
        if (submitBtn) {
          submitBtn.disabled = false;
        }
        if (formId) {
          document.getElementById(formId).reset();
          // Reset date selectors to today
          if (formId === 'daily-report-form') populateDateSelectors('dr-attendance-date');

          // Reset star rating if applicable
          if (formId === 'daily-report-form') {
            document.getElementById('dr-satisfaction-value').value = 0;
            updateStarRating(document.getElementById('dr-satisfaction'), 0);
          }
        }
        // Re-fetch all data after a successful submission to ensure UI is up-to-date
        google.script.run
          .withSuccessHandler(onInitialDataLoaded)
          .withFailureHandler(onFailure)
          .getInitialDataForUser(APP_DATA.userInfo.name);
      }

      // æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
      function onFailure(error) {
        console.error(error);
        const loader = document.getElementById('global-loader');
        if (loader.style.display !== 'none') {
          // If the initial load fails, show error in the global loader
          setGlobalLoaderText(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
        } else {
          // If it fails after initial load, use alert or specific status elements
          alert('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        }
      }
    </script>
  </body>
</html>
